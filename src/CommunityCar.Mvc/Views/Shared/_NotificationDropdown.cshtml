<!-- Notification Dropdown -->
<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle position-relative" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-bell"></i>
        <span class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle" id="notificationBadge" style="display: none;">
            0
        </span>
    </a>
    <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown" style="width: 350px; max-height: 500px; overflow-y: auto;">
        <div class="dropdown-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">Notifications</span>
            <a href="@Url.Action("Index", "Notifications", new { area = "Communications" })" class="btn btn-sm btn-link">
                View All
            </a>
        </div>
        <div class="dropdown-divider"></div>
        
        <div id="notificationList">
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <div class="dropdown-divider"></div>
        <div class="dropdown-footer text-center">
            <button class="btn btn-sm btn-link" onclick="markAllNotificationsAsRead()">
                <i class="fas fa-check-double"></i> Mark All as Read
            </button>
        </div>
    </div>
</li>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadNotifications();
            
            // Refresh notifications every 30 seconds
            setInterval(loadNotifications, 30000);
            
            // Load notifications when dropdown is opened
            $('#notificationDropdown').on('click', function() {
                loadNotifications();
            });
        });

        function loadNotifications() {
            $.ajax({
                url: '@Url.Action("Dropdown", "Notifications", new { area = "Communications" })',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        updateNotificationBadge(response.unreadCount);
                        renderNotifications(response.notifications);
                    }
                },
                error: function() {
                    $('#notificationList').html('<div class="text-center py-3 text-muted">Failed to load notifications</div>');
                }
            });
        }

        function updateNotificationBadge(count) {
            var badge = $('#notificationBadge');
            if (count > 0) {
                badge.text(count).show();
            } else {
                badge.hide();
            }
        }

        function renderNotifications(notifications) {
            var html = '';
            
            if (notifications.length === 0) {
                html = '<div class="text-center py-3 text-muted"><i class="fas fa-bell-slash me-2"></i>No notifications</div>';
            } else {
                notifications.forEach(function(notification) {
                    var readClass = notification.isRead ? '' : 'bg-light';
                    var newBadge = notification.isRead ? '' : '<span class="badge bg-primary me-2">New</span>';
                    var link = notification.link || '#';
                    
                    html += `
                        <a href="${link}" class="dropdown-item ${readClass}" onclick="markNotificationAsRead('${notification.id}')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="fw-bold small">${newBadge}${notification.title}</div>
                                    <div class="text-muted small text-truncate" style="max-width: 250px;">${notification.message}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">
                                        <i class="fas fa-clock me-1"></i>${notification.timeAgo}
                                    </div>
                                </div>
                            </div>
                        </a>
                    `;
                });
            }
            
            $('#notificationList').html(html);
        }

        function markNotificationAsRead(notificationId) {
            $.ajax({
                url: '@Url.Action("MarkAsRead", "Notifications", new { area = "Communications" })/' + notificationId,
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        updateNotificationBadge(response.unreadCount);
                    }
                }
            });
        }

        function markAllNotificationsAsRead() {
            $.ajax({
                url: '@Url.Action("MarkAllAsRead", "Notifications", new { area = "Communications" })',
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        loadNotifications();
                    }
                }
            });
        }
    </script>
}

<style>
    .notification-dropdown {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .notification-dropdown .dropdown-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .notification-dropdown .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .notification-dropdown .dropdown-item:hover {
        background-color: #f8f9fa;
    }
    
    .notification-dropdown .dropdown-header {
        padding: 0.75rem 1rem;
        background-color: #f8f9fa;
    }
    
    .notification-dropdown .dropdown-footer {
        padding: 0.5rem 1rem;
        background-color: #f8f9fa;
    }
</style>
