@model CommunityCar.Mvc.ViewModels.Feed.FeedViewModel
@using CommunityCar.Mvc.ViewModels.Feed
@{
    ViewData["Title"] = Localizer["Community Feed"];
}

@section RightSidebar {
    <partial name="Sidebars/_RightSidebar_Feed" />
}

@section Styles {
    <link rel="stylesheet" href="~/css/feed.css" />
}

@{
    ViewData["HeaderTitle"] = Localizer["Community Feed"];
    ViewData["HeaderDescription"] = Localizer["Latest updates from the community"];
    ViewData["HeaderIcon"] = "fas fa-stream";
    
    var recentUrl = Url.Action("Index", new { sortBy = FeedSortType.Recent });
    var popularUrl = Url.Action("Popular");
    var trendingUrl = Url.Action("Trending");
    
    var recentActive = Model.Filters.SortBy == FeedSortType.Recent ? "active" : "";
    var popularActive = Model.Filters.SortBy == FeedSortType.Popular ? "active" : "";
    var trendingActive = Model.Filters.SortBy == FeedSortType.Trending ? "active" : "";
    
    var actionsHtml = "<div class='btn-group' role='group'>" +
                      "<a href='" + recentUrl + "' class='btn btn-sm btn-light " + recentActive + "'>" +
                      "<i class='fas fa-clock'></i> " + Localizer["Recent"].Value +
                      "</a>" +
                      "<a href='" + popularUrl + "' class='btn btn-sm btn-light " + popularActive + "'>" +
                      "<i class='fas fa-fire'></i> " + Localizer["Popular"].Value +
                      "</a>" +
                      "<a href='" + trendingUrl + "' class='btn btn-sm btn-light " + trendingActive + "'>" +
                      "<i class='fas fa-chart-line'></i> " + Localizer["Trending"].Value +
                      "</a>" +
                      "</div>";
                      
    ViewData["HeaderActions"] = Html.Raw(actionsHtml);
}

<partial name="_InnerPageHeader" />

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" asp-action="Index" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">@Localizer["Content Type"]</label>
                <select name="type" class="form-select form-select-sm">
                    <option value="">@Localizer["All Content"]</option>
                    <option value="@((int)FeedItemType.Post)" selected="@(Model.Filters.ContentType == FeedItemType.Post)">@Localizer["Posts"]</option>
                    <option value="@((int)FeedItemType.Question)" selected="@(Model.Filters.ContentType == FeedItemType.Question)">@Localizer["Questions"]</option>
                    <option value="@((int)FeedItemType.Event)" selected="@(Model.Filters.ContentType == FeedItemType.Event)">@Localizer["Events"]</option>
                    <option value="@((int)FeedItemType.News)" selected="@(Model.Filters.ContentType == FeedItemType.News)">@Localizer["News"]</option>
                    <option value="@((int)FeedItemType.Guide)" selected="@(Model.Filters.ContentType == FeedItemType.Guide)">@Localizer["Guides"]</option>
                    <option value="@((int)FeedItemType.Review)" selected="@(Model.Filters.ContentType == FeedItemType.Review)">@Localizer["Reviews"]</option>
                    <option value="@((int)FeedItemType.Group)" selected="@(Model.Filters.ContentType == FeedItemType.Group)">@Localizer["Groups"]</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">@Localizer["Date Filter"]</label>
                <select name="dateFilter" class="form-select form-select-sm">
                    <option value="@((int)DateFilterType.All)" selected="@(Model.Filters.DateFilter == DateFilterType.All)">@Localizer["All Time"]</option>
                    <option value="@((int)DateFilterType.Today)" selected="@(Model.Filters.DateFilter == DateFilterType.Today)">@Localizer["Today"]</option>
                    <option value="@((int)DateFilterType.ThisWeek)" selected="@(Model.Filters.DateFilter == DateFilterType.ThisWeek)">@Localizer["This Week"]</option>
                    <option value="@((int)DateFilterType.ThisMonth)" selected="@(Model.Filters.DateFilter == DateFilterType.ThisMonth)">@Localizer["This Month"]</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">@Localizer["Search"]</label>
                <input type="text" name="search" class="form-control form-control-sm" placeholder="@Localizer["Search content..."]" value="@Model.Filters.SearchTerm" />
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-filter"></i> @Localizer["Filter"]
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Feed Items -->
@if (Model.Items.Any())
{
    <div class="feed-items">
        @foreach (var item in Model.Items)
        {
            <div class="card mb-3 feed-item" data-type="@item.Type">
                <div class="card-body">
                    <!-- Header -->
                    <div class="d-flex align-items-start mb-3">
                        <img src="@(item.AuthorAvatar ?? "/images/default-avatar.svg")" 
                             alt="@item.AuthorName" 
                             class="rounded-circle me-3" 
                             style="width: 48px; height: 48px; object-fit: cover;" />
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-0">@item.AuthorName</h6>
                                    <small class="text-muted">
                                        <span class="badge bg-@item.TypeColor me-1">
                                            <i class="fas @item.TypeIcon"></i> @item.TypeName
                                        </span>
                                        @item.TimeAgo
                                        @if (!string.IsNullOrEmpty(item.Category))
                                        {
                                            <span class="mx-1">â€¢</span>
                                            <span class="badge bg-secondary">@item.Category</span>
                                        }
                                    </small>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-bookmark me-2"></i>Save</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-share me-2"></i>Share</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-flag me-2"></i>Report</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="feed-content">
                        <h5 class="card-title mb-2">
                            <a href="@item.ActionUrl" class="text-decoration-none text-dark">
                                @item.Title
                            </a>
                        </h5>
                        <p class="card-text text-muted">@item.Content</p>

                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                        {
                            <img src="@item.ImageUrl" alt="@item.Title" class="img-fluid rounded mb-3" style="max-height: 400px; width: 100%; object-fit: cover;" />
                        }

                        @if (!string.IsNullOrEmpty(item.Tags))
                        {
                            <div class="mb-2">
                                @foreach (var tag in item.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                {
                                    <span class="badge bg-light text-dark me-1">#@tag.Trim()</span>
                                }
                            </div>
                        }

                        <!-- Type-specific info -->
                        @if (item.Type == FeedItemType.Question && item.IsResolved.HasValue)
                        {
                            <div class="mb-2">
                                @if (item.IsResolved.Value)
                                {
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle"></i> Resolved
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-question-circle"></i> Open
                                    </span>
                                }
                                @if (item.AnswerCount.HasValue && item.AnswerCount.Value > 0)
                                {
                                    <span class="ms-2 text-muted">
                                        <i class="fas fa-comments"></i> @item.AnswerCount answers
                                    </span>
                                }
                            </div>
                        }

                        @if (item.Type == FeedItemType.Event && item.EventStartTime.HasValue)
                        {
                            <div class="alert alert-info mb-2 py-2">
                                <i class="fas fa-calendar-alt me-2"></i>
                                <strong>@item.EventStartTime.Value.ToString("MMM dd, yyyy 'at' h:mm tt")</strong>
                                @if (!string.IsNullOrEmpty(item.EventLocation))
                                {
                                    <span class="ms-3">
                                        <i class="fas fa-map-marker-alt me-1"></i>@item.EventLocation
                                    </span>
                                }
                            </div>
                        }

                        @if (item.Type == FeedItemType.Review && item.Rating.HasValue)
                        {
                            <div class="mb-2">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <i class="fas fa-star @(i <= item.Rating.Value ? "text-warning" : "text-muted")"></i>
                                }
                                @if (item.IsRecommended.HasValue && item.IsRecommended.Value)
                                {
                                    <span class="badge bg-success ms-2">
                                        <i class="fas fa-thumbs-up"></i> Recommended
                                    </span>
                                }
                            </div>
                        }

                        @if (item.Type == FeedItemType.Group)
                        {
                            <div class="alert alert-light mb-2 py-2">
                                <i class="fas fa-users me-2"></i>
                                <strong>@item.MemberCount members</strong>
                                @if (item.IsPrivate.HasValue && item.IsPrivate.Value)
                                {
                                    <span class="badge bg-warning text-dark ms-2">
                                        <i class="fas fa-lock"></i> Private
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-success ms-2">
                                        <i class="fas fa-globe"></i> Public
                                    </span>
                                }
                                @if (item.IsUserMember.HasValue && item.IsUserMember.Value)
                                {
                                    <span class="badge bg-primary ms-2">
                                        <i class="fas fa-check"></i> Member
                                    </span>
                                }
                            </div>
                        }
                    </div>

                    <!-- Footer -->
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                        <div class="d-flex gap-3">
                            <span class="text-muted">
                                <i class="fas fa-eye me-1"></i> @item.ViewCount
                            </span>
                            <span class="text-muted">
                                <i class="fas fa-heart me-1"></i> @item.LikeCount
                            </span>
                            <span class="text-muted">
                                <i class="fas fa-comment me-1"></i> @item.CommentCount
                            </span>
                        </div>
                        <a href="@item.ActionUrl" class="btn btn-sm btn-outline-primary">
                            @item.ActionText <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Pagination -->
    @if (Model.TotalPages > 1)
    {
        <nav aria-label="Feed pagination">
            <ul class="pagination justify-content-center">
                <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                    <a class="page-link" 
                       asp-action="Index" 
                       asp-route-page="@(Model.CurrentPage - 1)"
                       asp-route-type="@Model.Filters.ContentType"
                       asp-route-search="@Model.Filters.SearchTerm"
                       asp-route-dateFilter="@Model.Filters.DateFilter"
                       asp-route-sortBy="@Model.Filters.SortBy">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                </li>

                @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                {
                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                        <a class="page-link" 
                           asp-action="Index" 
                           asp-route-page="@i"
                           asp-route-type="@Model.Filters.ContentType"
                           asp-route-search="@Model.Filters.SearchTerm"
                           asp-route-dateFilter="@Model.Filters.DateFilter"
                           asp-route-sortBy="@Model.Filters.SortBy">
                            @i
                        </a>
                    </li>
                }

                <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                    <a class="page-link" 
                       asp-action="Index" 
                       asp-route-page="@(Model.CurrentPage + 1)"
                       asp-route-type="@Model.Filters.ContentType"
                       asp-route-search="@Model.Filters.SearchTerm"
                       asp-route-dateFilter="@Model.Filters.DateFilter"
                       asp-route-sortBy="@Model.Filters.SortBy">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    }
}
else
{
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No content found</h5>
            <p class="text-muted">Try adjusting your filters or check back later for new content.</p>
        </div>
    </div>
}

@section Scripts {
    <script src="~/js/feed.js"></script>
    <script>
        $(document).ready(function() {
            // Smooth scroll to top when pagination is clicked
            $('.pagination a').on('click', function() {
                $('html, body').animate({ scrollTop: 0 }, 300);
            });

            // Add hover effect to feed items
            $('.feed-item').hover(
                function() { $(this).addClass('shadow-sm'); },
                function() { $(this).removeClass('shadow-sm'); }
            );
        });
    </script>
}
