@using CommunityCar.Domain.DTOs.Community
@model QuestionDto
@{
    ViewData["Title"] = Model.Title;
    var answers = ViewBag.Answers as IEnumerable<AnswerDto> ?? new List<AnswerDto>();
}

<link rel="stylesheet" href="~/css/pages/qa.css" />

<div class="container qa-container py-4">
    <div class="row">
        <div class="col-12">
            <!-- Quick Tip Alert -->
            <div class="alert alert-info border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, rgba(13, 110, 253, 0.1) 0%, rgba(13, 110, 253, 0.05) 100%); border-left: 4px solid var(--bs-info) !important;">
                <div class="d-flex align-items-start">
                    <i class="fas fa-lightbulb text-info fs-4 me-3 mt-1"></i>
                    <div>
                        <h6 class="alert-heading fw-bold mb-1">Quick Tip</h6>
                        <p class="mb-0 small">Be detailed and specific when providing answers to help the community better.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="question-header mb-4">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="h2 mb-2">@Model.Title</h1>
                        <div class="text-secondary small d-flex gap-3">
                            <span>Asked @Model.CreatedAt.ToString("MMM dd, yyyy")</span>
                            <span>Viewed @Model.ViewCount times</span>
                            @if (Model.IsResolved)
                            {
                                <span class="text-success"><i class="bi bi-check-circle-fill"></i> Resolved</span>
                            }
                        </div>
                    </div>
                    @if (Model.Category != null)
                    {
                        <span class="badge" style="background-color: @(Model.Category.Color ?? "#6c757d"); color: white; padding: 0.5em 1em;">
                            <i class="@Model.Category.Icon me-1"></i> @Model.Category.Name
                        </span>
                    }
                </div>
            </div>

            <div class="question-detail">
                <div class="question-detail-header">
                    <div class="d-flex gap-3">
                        <div class="vote-controls d-flex flex-column align-items-center" style="width: 50px;">
                            <button class="btn btn-link p-0 fs-3 @(Model.CurrentUserVote == 1 ? "vote-active-up" : "link-secondary")" onclick="voteQuestion('@Model.Id', true)"><i class="bi bi-caret-up-fill"></i></button>
                            <span class="fw-bold fs-4">@Model.VoteCount</span>
                            <button class="btn btn-link p-0 fs-3 @(Model.CurrentUserVote == -1 ? "vote-active-down" : "link-secondary")" onclick="voteQuestion('@Model.Id', false)"><i class="bi bi-caret-down-fill"></i></button>
                            
                            <hr class="w-100 my-2" />
                            
                            <button class="btn btn-link link-secondary p-0 fs-4 mb-2" onclick="bookmarkQuestion('@Model.Id')" id="btnBookmark">
                                <i class="bi bi-bookmark"></i>
                            </button>
                            
                            <div class="dropdown">
                                <button class="btn btn-link link-secondary p-0 fs-4 mb-2 dropdown-toggle-no-caret" data-bs-toggle="dropdown">
                                    <i class="bi bi-emoji-smile"></i>
                                </button>
                                <ul class="dropdown-menu p-2">
                                    <li class="d-flex gap-2">
                                        <button class="btn btn-sm btn-light" onclick="reactQuestion('@Model.Id', 1)" title="Like">üëç</button>
                                        <button class="btn btn-sm btn-light" onclick="reactQuestion('@Model.Id', 2)" title="Love">‚ù§Ô∏è</button>
                                        <button class="btn btn-sm btn-light" onclick="reactQuestion('@Model.Id', 3)" title="Celebrate">üôå</button>
                                        <button class="btn btn-sm btn-light" onclick="reactQuestion('@Model.Id', 4)" title="Think">ü§î</button>
                                        <button class="btn btn-sm btn-light" onclick="reactQuestion('@Model.Id', 5)" title="Insightful">üí°</button>
                                    </li>
                                </ul>
                            </div>
                            
                            <div class="dropdown d-inline-block">
                                <button class="btn btn-link link-secondary p-0 fs-4 dropdown-toggle-no-caret" 
                                        type="button" 
                                        data-bs-toggle="dropdown" 
                                        aria-expanded="false" 
                                        title="Share">
                                    <i class="bi bi-share"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-2" style="min-width: 150px;">
                                    <li>
                                        <button class="dropdown-item rounded small mb-1" onclick="shareQuestion('@Model.Id', 'Facebook')">
                                            <i class="fab fa-facebook text-primary me-2"></i>Facebook
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item rounded small mb-1" onclick="shareQuestion('@Model.Id', 'Twitter')">
                                            <i class="fab fa-x-twitter text-dark me-2"></i>Twitter
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item rounded small mb-1" onclick="shareQuestion('@Model.Id', 'LinkedIn')">
                                            <i class="fab fa-linkedin text-primary me-2"></i>LinkedIn
                                        </button>
                                    </li>
                                    <li><hr class="dropdown-divider my-1"></li>
                                    <li>
                                        <button class="dropdown-item rounded small" onclick="shareQuestion('@Model.Id', 'Clipboard')">
                                            <i class="fas fa-link text-secondary me-2"></i>Copy Link
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="reaction-summary mb-2" id="questionReactions">
                                <!-- Populated via JS -->
                            </div>
                            <div class="question-detail-content">
                                @Html.Raw(Model.Content.Replace("\n", "<br/>"))
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <div class="tags">
                                    @if (!string.IsNullOrEmpty(Model.Tags))
                                    {
                                        foreach (var tag in Model.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                        {
                                            <a href="@Url.Action("Index", new { tag = tag.Trim() })" class="badge bg-light text-secondary text-decoration-none me-1">@tag.Trim()</a>
                                        }
                                    }
                                </div>
                                <div class="author-info p-2 bg-light rounded" style="min-width: 200px;">
                                    <div class="text-secondary smallest mb-1">Asked by</div>
                                        <div>
                                            <div class="fw-bold small">
                                                @(Model.AuthorName ?? "User")
                                                @if (Model.AuthorRankName != "Standard")
                                                {
                                                    var iconClass = Model.AuthorRankName switch
                                                    {
                                                        "Master" => "fa-star-of-life text-danger",
                                                        "Moderator" => "fa-shield-halved text-dark",
                                                        "Author" => "fa-pen-nib text-info",
                                                        "Reviewer" => "fa-star text-success",
                                                        "Expert" => "fa-crown text-warning",
                                                        _ => "fa-certificate text-secondary"
                                                    };
                                                    <i class="fas @iconClass ms-1 x-small" title="@Model.AuthorRankName Member"></i>
                                                }
                                            </div>
                                            @if (User.Identity?.IsAuthenticated == true && Model.AuthorId == Guid.Parse(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? Guid.Empty.ToString()))
                                            {
                                                <div class="mt-1 d-flex gap-2">
                                                    <button type="button" class="btn-link p-0 border-0 bg-transparent text-secondary smallest text-decoration-none hover-primary" data-bs-toggle="modal" data-bs-target="#editQuestionModal">
                                                        <i class="bi bi-pencil me-1"></i>Edit
                                                    </button>
                                                    <button type="button" class="btn-link p-0 border-0 bg-transparent text-secondary smallest text-decoration-none hover-danger" onclick="confirmDeleteQuestion('@Model.Id')">
                                                        <i class="bi bi-trash me-1"></i>Delete
                                                    </button>
                                                </div>
                                            }
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="answers-section">
                <h3 class="answers-header">@answers.Count() Answers</h3>
                <div id="answersList">
                @foreach (var answer in answers)
                {
                    <div class="card mb-3 @(answer.IsAccepted ? "border-success" : "")" id="answer-@answer.Id">
                        <div class="card-body">
                            <div class="d-flex gap-3">
                                <div class="vote-controls d-flex flex-column align-items-center" style="width: 40px;">
                                    <button class="btn btn-link p-0 fs-4 @(answer.CurrentUserVote == 1 ? "vote-active-up" : "link-secondary")" onclick="voteAnswer('@answer.Id', true)"><i class="bi bi-caret-up-fill"></i></button>
                                    <span class="fw-bold">@answer.VoteCount</span>
                                    <button class="btn btn-link p-0 fs-4 @(answer.CurrentUserVote == -1 ? "vote-active-down" : "link-secondary")" onclick="voteAnswer('@answer.Id', false)"><i class="bi bi-caret-down-fill"></i></button>
                                    
                                    @if (User.Identity?.IsAuthenticated == true && Model.AuthorId == Guid.Parse(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? Guid.Empty.ToString()))
                                    {
                                        <button class="btn btn-link p-0 mt-2 @(answer.IsAccepted ? "text-success" : "text-secondary")" 
                                                onclick="toggleAcceptAnswer('@Model.Id', '@answer.Id', @(answer.IsAccepted.ToString().ToLower()))"
                                                title="@(answer.IsAccepted ? "Unaccept this answer" : "Accept this answer")">
                                            <i class="bi @(answer.IsAccepted ? "bi-check-circle-fill" : "bi-check-circle") fs-3"></i>
                                        </button>
                                    }
                                    else if (answer.IsAccepted)
                                    {
                                        <i class="bi bi-check-circle-fill text-success fs-3 mt-2" title="Accepted Answer"></i>
                                    }
                                </div>
                                <div class="flex-grow-1">
                                    <div class="answer-content">
                                        @Html.Raw(answer.Content.Replace("\n", "<br/>"))
                                    </div>
                                    <div class="d-flex justify-content-end mt-3">
                                        <div class="author-info p-2" style="min-width: 150px;">
                                            <div class="text-secondary smallest mb-1">Answered @answer.CreatedAt.ToString("MMM dd, yyyy")</div>
                                            <div class="d-flex align-items-center gap-2">
                                                <a asp-area="Identity" asp-controller="Profiles" asp-action="Index" asp-route-userId="@answer.AuthorId" class="fw-bold small text-primary text-decoration-none hover-opacity">
                                                    @(answer.AuthorName ?? "User")
                                                    @if (answer.AuthorRankName != "Standard")
                                                    {
                                                        var iconClass = answer.AuthorRankName switch
                                                        {
                                                            "Master" => "fa-star-of-life text-danger",
                                                            "Moderator" => "fa-shield-halved text-dark",
                                                            "Author" => "fa-pen-nib text-info",
                                                            "Reviewer" => "fa-star text-success",
                                                            "Expert" => "fa-crown text-warning",
                                                            _ => "fa-certificate text-secondary"
                                                        };
                                                        <i class="fas @iconClass ms-1 x-small" title="@answer.AuthorRankName Member"></i>
                                                    }
                                                </a>
                                                @if (User.Identity?.IsAuthenticated == true && answer.AuthorId == Guid.Parse(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? Guid.Empty.ToString()))
                                                {
                                                    <span class="text-muted d-none d-sm-inline">‚Ä¢</span>
                                                    <button type="button" class="btn-link p-0 border-0 bg-transparent text-secondary smallest text-decoration-none hover-primary" onclick="editAnswer('@answer.Id')">Edit</button>
                                                    <span class="text-muted d-none d-sm-inline">‚Ä¢</span>
                                                    <button type="button" class="btn-link p-0 border-0 bg-transparent text-secondary smallest text-decoration-none hover-danger" onclick="confirmDeleteAnswer('@Model.Id', '@answer.Id')">Delete</button>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Comments Section -->
                            <div class="comments-section mt-3 ps-5 border-start-0">
                                <div id="comments-list-@answer.Id" class="comments-list bg-light rounded-3 p-2 mb-2" style="@(answer.Comments != null && answer.Comments.Any() ? "" : "display:none;")">
                                    @if (answer.Comments != null)
                                    {
                                        foreach (var comment in answer.Comments)
                                        {
                                            <partial name="_CommentItem" model="comment" />
                                        }
                                    }
                                </div>
                                
                                <button class="btn btn-link btn-sm text-decoration-none p-0 text-muted" onclick="toggleCommentForm('@answer.Id')">
                                    <i class="fas fa-comment-alt me-1"></i>Add a comment
                                </button>
                                
                                <div id="comment-form-@answer.Id" class="comment-form mt-2 d-none">
                                    <form class="submit-comment-form" data-answer-id="@answer.Id">
                                        <input type="hidden" name="AnswerId" value="@answer.Id" />
                                        <input type="hidden" name="QuestionId" value="@Model.Id" />
                                        <div class="input-group input-group-sm">
                                            <input type="text" name="Content" class="form-control" placeholder="Add a comment..." required minlength="5">
                                            <button class="btn btn-primary" type="submit">Post</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                </div>
            </div>

            <div class="post-answer mt-5">
                <h4 class="h5 fw-bold mb-3">Your Answer</h4>
                <form id="answerForm" asp-controller="Answers" asp-action="Create" method="post">
                    <input type="hidden" name="QuestionId" value="@Model.Id" />
                    <div id="answerValidationErrors" class="alert alert-danger d-none mb-3"></div>
                    <div class="form-group mb-3">
                        <textarea name="Content" class="form-control" rows="8" placeholder="Type your answer here (min 20 chars)..."></textarea>
                    </div>
                    <button type="submit" id="btnPostAnswer" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none mr-2" role="status" aria-hidden="true"></span>
                        Post Your Answer
                    </button>
                </form>
            </div>
        </div>
    </div>

    @* Related Questions Section *@
    @if (ViewBag.RelatedQuestions != null && ((List<QuestionDto>)ViewBag.RelatedQuestions).Any())
    {
        <div class="row mt-5">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="h5 fw-bold mb-0">Related Questions</h4>
                </div>
                
                <div class="row g-3 related-questions">
                    @foreach (var relatedQuestion in (List<QuestionDto>)ViewBag.RelatedQuestions)
                    {
                        <div class="col-md-6">
                            <div class="card h-100 hover-lift">
                                <div class="card-body">
                                    <h5 class="h6 card-title mb-2">
                                        <a href="@Url.Action("Details", "Questions", new { idOrSlug = relatedQuestion.Slug ?? relatedQuestion.Id.ToString() })" class="text-decoration-none text-dark">
                                            @relatedQuestion.Title
                                        </a>
                                    </h5>
                                    
                                    <div class="d-flex gap-3 text-muted small mt-2">
                                        <span title="Vote Count">
                                            <i class="bi bi-arrow-up-circle"></i> @relatedQuestion.VoteCount
                                        </span>
                                        <span title="Answer Count">
                                            <i class="bi bi-chat-left-text"></i> @relatedQuestion.AnswerCount
                                        </span>
                                        <span title="View Count">
                                            <i class="bi bi-eye"></i> @relatedQuestion.ViewCount
                                        </span>
                                    </div>
                                    
                                    @if (relatedQuestion.TagList != null && relatedQuestion.TagList.Any())
                                    {
                                        <div class="mt-2">
                                            @foreach (var tag in relatedQuestion.TagList.Take(3))
                                            {
                                                <span class="badge bg-light text-secondary me-1">@tag.Name</span>
                                            }
                                        </div>
                                    }
                                    
                                    <div class="d-flex align-items-center gap-2 mt-3 text-muted smallest">
                                        <span>by</span>
                                        <a href="@Url.Action("Index", "Profiles", new { area = "Identity", id = relatedQuestion.AuthorId })" class="text-primary text-decoration-none fw-bold">
                                            @relatedQuestion.AuthorName
                                        </a>
                                        <span class="text-muted">‚Ä¢ @relatedQuestion.CreatedAt.ToString("MMM dd, yyyy")</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

<!-- Edit Question Modal -->
<div class="modal fade modal-premium" id="editQuestionModal" tabindex="-1" aria-labelledby="editQuestionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <div class="w-100">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="modal-title" id="editQuestionModalLabel">
                            <i class="bi bi-pencil-square me-2 text-primary"></i>Edit Question
                        </h5>
                        <button type="button" class="btn-close-premium" data-bs-dismiss="modal" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="mb-0 smallest text-muted mt-2">Revise your question to make it clearer for the community.</p>
                </div>
            </div>
            <div class="modal-body">
                <form id="editQuestionForm">
                    <input type="hidden" name="Id" value="@Model.Id" />
                    <div class="mb-4">
                        <label class="form-label fw-bold small text-secondary">Title</label>
                        <input type="text" name="Title" class="form-control form-control-lg" value="@Model.Title" required minlength="10" maxlength="150" placeholder="e.g. How to replace a car battery?">
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold small text-secondary">Category</label>
                        <select name="CategoryId" class="form-select" required>
                            <option value="">-- Select Category --</option>
                            @foreach (var category in (IEnumerable<CategoryDto>)ViewBag.Categories)
                            {
                                <option value="@category.Id" selected="@(category.Id == Model.CategoryId)">@category.Name</option>
                            }
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold small text-secondary">Details</label>
                        <textarea name="Content" class="form-control" rows="10" required minlength="20" placeholder="Explain your question in detail...">@Model.Content</textarea>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold small text-secondary">Tags</label>
                        <input type="text" name="Tags" class="form-control" data-tag-input="true" data-max-tags="5" value="@Model.Tags" placeholder="e.g. battery, maintenance, car">
                        <div class="form-text smallest text-muted mt-1">Press Enter or comma to add a tag. Max 5 tags.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light px-4 fw-600" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-4 fw-700 shadow-sm" onclick="saveQuestionEdit()" id="btnSaveQuestion">
                    <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <style>
        .vote-active-up { color: #f48024 !important; }
        .vote-active-down { color: #f48024 !important; }
        .bookmark-active { color: #0d6efd !important; }
        .dropdown-toggle-no-caret::after { display: none; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        // Tag Suggestions for Edit Modal
        window.tagSuggestions = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.TagSuggestions ?? new List<TagDto>()));

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/questionHub")
            .build();

        connection.on("ReceiveAnswer", function (data) {
            // Check if this answer belongs to the current question
            if (data.questionId === '@Model.Id') {
                fetch(`/Answers/GetAnswerCard/${data.answerId}`)
                    .then(response => response.json())
                    .then(answer => {
                        const listContainer = document.getElementById('answersList');
                        if(listContainer) {
                            // Build answer HTML from JSON
                            const answerHtml = buildAnswerHtml(answer);
                            listContainer.insertAdjacentHTML('beforeend', answerHtml);
                            
                            // Update count text if exists
                            const header = document.querySelector('h3.h5.mb-3');
                            if (header && header.innerText.includes('Answers')) {
                                const currentCount = parseInt(header.innerText) || 0;
                                header.innerText = `${currentCount + 1} Answers`;
                            }

                            Toast.show("New answer received!", "info");
                        }
                    })
                    .catch(err => console.error("Failed to load new answer card", err));
            }
        });

        connection.on("ReceiveComment", function (data) {
            // Find the comment list for this answer
            const commentList = document.getElementById(`comments-${data.answerId}`);
            if (commentList) {
                // Build comment HTML from JSON
                const commentHtml = buildCommentHtml(data.comment);
                commentList.insertAdjacentHTML('beforeend', commentHtml);
                Toast.show("New comment received!", "info");
            }
        });

        connection.start().catch(function (err) {
            return console.error(err.toString());
        });

        // Helper function to build answer HTML from JSON
        function buildAnswerHtml(answer) {
            const isAuthor = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value' === answer.authorId;
            const isQuestionAuthor = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value' === '@Model.AuthorId';
            
            return `
                <div class="answer-item d-flex gap-3 p-3 border rounded mb-3" id="answer-${answer.id}">
                    <div class="vote-controls d-flex flex-column align-items-center" style="width: 40px;">
                        <button class="btn btn-link p-0 fs-4 link-secondary" onclick="voteAnswer('${answer.id}', true)"><i class="bi bi-caret-up-fill"></i></button>
                        <span class="fw-bold">${answer.voteCount}</span>
                        <button class="btn btn-link p-0 fs-4 link-secondary" onclick="voteAnswer('${answer.id}', false)"><i class="bi bi-caret-down-fill"></i></button>
                        ${isQuestionAuthor ? `
                            <button class="btn btn-link p-0 mt-2 text-secondary" onclick="toggleAcceptAnswer('@Model.Id', '${answer.id}', false)" title="Accept this answer">
                                <i class="bi bi-check-circle fs-3"></i>
                            </button>
                        ` : ''}
                    </div>
                    <div class="flex-grow-1">
                        <div class="answer-content mb-3">${answer.content}</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <a href="/Profiles/Index/${answer.authorId}" class="fw-bold small text-primary text-decoration-none hover-opacity">
                                    ${answer.authorName}
                                </a>
                                ${isAuthor ? `
                                    <span class="text-muted d-none d-sm-inline">‚Ä¢</span>
                                    <button type="button" class="btn-link p-0 border-0 bg-transparent text-secondary smallest text-decoration-none hover-primary" onclick="editAnswer('${answer.id}')">Edit</button>
                                    <span class="text-muted d-none d-sm-inline">‚Ä¢</span>
                                    <button type="button" class="btn-link p-0 border-0 bg-transparent text-secondary smallest text-decoration-none hover-danger" onclick="deleteAnswer('@Model.Id', '${answer.id}')">Delete</button>
                                ` : ''}
                            </div>
                            <span class="text-muted smallest">Just now</span>
                        </div>
                        <div class="mt-2">
                            <button onclick="toggleCommentForm('${answer.id}')" class="btn btn-link btn-sm p-0 text-secondary"><i class="bi bi-chat"></i> Add Comment</button>
                        </div>
                        <div id="comment-form-${answer.id}" class="comment-form mt-2 d-none">
                            <form class="submit-comment-form">
                                <input type="hidden" name="AnswerId" value="${answer.id}" />
                                <div class="input-group">
                                    <input type="text" name="Content" class="form-control form-control-sm" placeholder="Write a comment..." required />
                                    <button type="submit" class="btn btn-primary btn-sm">Post</button>
                                </div>
                            </form>
                        </div>
                        <div id="comments-${answer.id}" class="mt-2"></div>
                    </div>
                </div>
            `;
        }

        // Helper function to build comment HTML from JSON
        function buildCommentHtml(comment) {
            return `
                <div class="comment-item border-start border-2 border-info ps-2 py-1 mb-1">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="fw-bold smallest">${comment.authorName}</span>
                            <span class="text-muted smallest ms-2">${comment.content}</span>
                        </div>
                        <span class="text-muted x-small">Just now</span>
                    </div>
                </div>
            `;
        }

        function toggleCommentForm(answerId) {
            const form = document.getElementById(`comment-form-${answerId}`);
            form.classList.toggle('d-none');
            if (!form.classList.contains('d-none')) {
                form.querySelector('input[name="Content"]').focus();
            }
        }

        // Delegate comment submission
        document.addEventListener('submit', async function(e) {
            if (e.target.matches('.submit-comment-form')) {
                e.preventDefault();
                const form = e.target;
                const btn = form.querySelector('button');
                const input = form.querySelector('input[name="Content"]');
                
                btn.disabled = true;
                
                try {
                    const formData = new FormData(form);
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                     
                    const response = await fetch('/Comments/Create', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': token,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (response.ok) {
                        input.value = '';
                        form.closest('.comment-form').classList.add('d-none');
                    } else {
                        const data = await response.json();
                        Toast.show(data.message || "Failed to post comment", "error");
                    }
                } catch (err) {
                    console.error(err);
                    Toast.show("Error posting comment", "error");
                } finally {
                    btn.disabled = false;
                }
            }
        });

        const votingLocks = new Set();
        async function voteQuestion(id, isUpvote) {
            if (votingLocks.has(id)) return;
            votingLocks.add(id);

            const btnUp = document.querySelector(`.question-detail button[onclick*="voteQuestion('${id}', true)"]`);
            const btnDown = document.querySelector(`.question-detail button[onclick*="voteQuestion('${id}', false)"]`);
            const countSpan = btnUp.nextElementSibling;
            
            const currentScore = parseInt(countSpan.innerText);
            
            try {
                const response = await fetch(`/Questions/Vote/${id}?isUpvote=${isUpvote}`, { 
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // If backend return same count and userVote as before, it means toggle-off was blocked or score floor hit
                    if (data.voteCount === currentScore) {
                        // Minimal feedback: just a slight shake if it was a "no-change" event
                        const activeBtn = isUpvote ? btnUp : btnDown;
                        activeBtn.classList.add('vote-blocked');
                        setTimeout(() => activeBtn.classList.remove('vote-blocked'), 300);
                        
                        // If it's already active, we don't need a toast, just stay active.
                    } else {
                        countSpan.innerText = data.voteCount;
                        animateElement(countSpan, 'pop');
                    }
                    
                    btnUp.classList.remove('vote-active-up');
                    btnUp.classList.add('link-secondary');
                    btnDown.classList.remove('vote-active-down');
                    btnDown.classList.add('link-secondary');

                    if (data.userVote === 1 || data.UserVote === 1) {
                        btnUp.classList.add('vote-active-up');
                        btnUp.classList.remove('link-secondary');
                    } else if (data.userVote === -1 || data.UserVote === -1) {
                        btnDown.classList.add('vote-active-down');
                        btnDown.classList.remove('link-secondary');
                    }
                }
            } catch (err) { 
                console.error(err); 
            } finally {
                votingLocks.delete(id);
            }
        }

        async function voteAnswer(id, isUpvote) {
            if (votingLocks.has(id)) return;
            votingLocks.add(id);

            const btnUp = document.querySelector(`button[onclick="voteAnswer('${id}', true)"]`);
            const btnDown = document.querySelector(`button[onclick="voteAnswer('${id}', false)"]`);
            const countSpan = btnUp.nextElementSibling;

            try {
                const response = await fetch(`/Answers/Vote/${id}?isUpvote=${isUpvote}`, { 
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    countSpan.innerText = data.voteCount;
                    
                    btnUp.classList.remove('vote-active-up');
                    btnUp.classList.add('link-secondary');
                    btnDown.classList.remove('vote-active-down');
                    btnDown.classList.add('link-secondary');

                    if (data.userVote === 1) {
                        btnUp.classList.add('vote-active-up');
                        btnUp.classList.remove('link-secondary');
                    } else if (data.userVote === -1) {
                        btnDown.classList.add('vote-active-down');
                        btnDown.classList.remove('link-secondary');
                    }
                    
                    let message = data.userVote === 1 ? "Upvoted!" : (data.userVote === -1 ? "Downvoted!" : "Vote removed.");
                    Toast.show(message, "success");
                } else {
                    const data = await response.json();
                    Toast.show(data.message || "Operation failed", "error");
                }
            } catch (err) { 
                console.error(err); 
        function bookmarkQuestion(id) {
            const btn = document.getElementById('btnBookmark');
            const icon = btn.querySelector('i');
            
            fetch(`/Questions/Bookmark/${id}`, { 
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(async r => {
                    const data = await r.json();
                    if (r.ok) {
                        if (data.isBookmarked) {
                            icon.className = 'bi bi-bookmark-fill bookmark-active';
                            // Toast.show("Bookmarked successfully!", "success");
                        } else {
                            icon.className = 'bi bi-bookmark';
                            // Toast.show("Bookmark removed.", "success");
                        }
                    } else {
                        Toast.show(data.message || "Failed to bookmark", "error");
                    }
                });
        }

        function reactQuestion(id, type) {
            fetch(`/Questions/React/${id}?reactionType=${type}`, { 
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(async r => {
                    const data = await r.json();
                    if (r.ok) {
                        updateReactionSummary(data);
                    } else {
                        Toast.show(data.message || "Reaction failed", "error");
                    }
                });
        }

        function shareQuestion(id, platform) {
            const url = window.location.href;
            
            fetch(`/Questions/Share/${id}?platform=${platform}&sharedUrl=${encodeURIComponent(url)}`, { 
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(async r => {
                    if (r.ok) {
                        const shareUrl = encodeURIComponent(url);
                        const title = encodeURIComponent(document.title);
                        
                        switch(platform) {
                            case 'Facebook':
                                window.open(`https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`, '_blank');
                                break;
                            case 'Twitter':
                                window.open(`https://twitter.com/intent/tweet?url=${shareUrl}&text=${title}`, '_blank');
                                break;
                            case 'LinkedIn':
                                window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`, '_blank');
                                break;
                            case 'Clipboard':
                                navigator.clipboard.writeText(url).then(() => {
                                    Toast.show("Link copied to clipboard!", "success");
                                });
                                break;
                        }
                    } else {
                        Toast.show("Share failed", "error");
                    }
                });
        }

        function updateReactionSummary(summary) {
            const container = document.getElementById('questionReactions');
            if (!container) return;
            
            let html = '';
            summary.forEach(s => {
                const rType = s.reactionType !== undefined ? s.reactionType : s.ReactionType;
                const count = s.count !== undefined ? s.count : s.Count;
                const isUser = s.isUserReaction !== undefined ? s.isUserReaction : s.IsUserReaction;
                
                const emoji = getEmoji(rType);
                const label = getReactionLabel(rType);
                html += `<span class="badge bg-light text-dark border me-1 ${isUser ? 'border-primary' : ''}" 
                                style="cursor:pointer" 
                                data-bs-toggle="tooltip" title="${label}"
                                onclick="reactQuestion('@Model.Id', ${rType})">
                            ${emoji} ${count}
                         </span>`;
            });
            container.innerHTML = html;

            var tooltipTriggerList = [].slice.call(container.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        function getEmoji(type) {
            switch(type) {
                case 1: return 'üëç';
                case 2: return '‚ù§Ô∏è';
                case 3: return 'üôå';
                case 4: return 'ü§î';
                case 5: return 'üí°';
                case 6: return '‚ùì';
                default: return '‚ùì';
            }
        }

        function getReactionLabel(type) {
            switch(type) {
                case 1: return 'Like';
                case 2: return 'Love';
                case 3: return 'Celebrate';
                case 4: return 'Think';
                case 5: return 'Insightful';
                case 6: return 'Curious';
                default: return 'React';
            }
        }

        // Removed local showToast function as it's now global
        
        fetch(`/Questions/Reactions/@Model.Id`)
            .then(r => r.json())
            .then(data => updateReactionSummary(data));

        // Answer acceptance logic
        async function toggleAcceptAnswer(qId, aId, isCurrentlyAccepted) {
            const endpoint = isCurrentlyAccepted ? '/Questions/UnacceptAnswer' : '/Questions/AcceptAnswer';
            const formData = new FormData();
            formData.append('questionId', qId);
            if (!isCurrentlyAccepted) formData.append('answerId', aId);

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (response.ok) {
                    Toast.show(isCurrentlyAccepted ? "Answer unaccepted" : "Answer accepted!", "success");
                    location.reload(); // Quick refresh to update indicators
                } else {
                    Toast.show("Failed to update answer acceptance", "error");
                }
            } catch (err) {
                console.error(err);
                Toast.show("Error processing request", "error");
            }
        }

        function editAnswer(aId) {
            const answerItem = document.getElementById(`answer-${aId}`) || document.querySelector(`.card:has(button[onclick*="deleteAnswer('@Model.Id', '${aId}')"])`);
            if (!answerItem) return;

            const contentDiv = answerItem.querySelector('.answer-content');
            if (contentDiv.querySelector('textarea')) return; // Already editing

            const originalHtml = contentDiv.innerHTML;
            const originalContent = originalHtml.replace(/<br\s*\/?>/gi, '\n').trim();
            
            contentDiv.innerHTML = `
                <div class="edit-answer-container mt-2">
                    <textarea class="form-control bg-light border-0 mb-2" rows="5" style="border-radius: 0.75rem;">${originalContent}</textarea>
                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btn btn-sm btn-light px-3" onclick="cancelAnswerEdit('${aId}', '${encodeURIComponent(originalHtml)}')">Cancel</button>
                        <button class="btn btn-sm btn-primary px-3" onclick="saveAnswerEdit('${aId}')">Save</button>
                    </div>
                </div>
            `;
        }

        function cancelAnswerEdit(aId, encodedHtml) {
            const answerItem = document.getElementById(`answer-${aId}`) || document.querySelector(`.card:has(button[onclick*="deleteAnswer('@Model.Id', '${aId}')"])`);
            if (!answerItem) return;
            const contentDiv = answerItem.querySelector('.answer-content');
            contentDiv.innerHTML = decodeURIComponent(encodedHtml);
        }

        async function saveAnswerEdit(aId) {
            const answerItem = document.getElementById(`answer-${aId}`) || document.querySelector(`.card:has(button[onclick*="deleteAnswer('@Model.Id', '${aId}')"])`);
            const textarea = answerItem.querySelector('textarea');
            const newContent = textarea.value.trim();

            if (newContent.length < 20) {
                Toast.show("Answer must be at least 20 characters.", "error");
                return;
            }

            const btn = textarea.nextElementSibling.querySelector('.btn-primary');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving';

            try {
                const formData = new FormData();
                formData.append('id', aId);
                formData.append('content', newContent);
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                const response = await fetch(`/Answers/Edit/${aId}`, {
                    method: 'POST',
                    body: formData,
                    headers: { 
                        'RequestVerificationToken': token,
                        'X-Requested-With': 'XMLHttpRequest' 
                    }
                });

                if (response.ok) {
                    const contentDiv = answerItem.querySelector('.answer-content');
                    contentDiv.innerHTML = newContent.replace(/\n/g, '<br/>');
                    Toast.show("Answer updated!", "success");
                } else {
                    Toast.show("Failed to update answer", "error");
                }
            } catch (err) {
                console.error(err);
                Toast.show("Error saving answer", "error");
            } finally {
                btn.disabled = false;
                btn.innerText = "Save";
            }
        }

        function confirmDeleteQuestion(id) {
            window.Modal.confirm(
                'Delete Question?',
                'Are you sure you want to permanently delete this question? This action cannot be undone.',
                'Delete Permanently'
            ).then((result) => {
                if (result.isConfirmed) {
                    performDeleteQuestion(id);
                }
            });
        }

        async function performDeleteQuestion(id) {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            
            try {
                const response = await fetch(`/Questions/Delete/${id}`, {
                    method: 'POST',
                    headers: { 
                        'RequestVerificationToken': token,
                        'X-Requested-With': 'XMLHttpRequest' 
                    }
                });
                
                if (response.ok) {
                    Toast.show("Question deleted!", "success");
                    window.location.href = '/Questions';
                } else {
                    Toast.show("Failed to delete question", "error");
                }
            } catch (err) {
                console.error(err);
                Toast.show("Error deleting question", "error");
            }
        }

        async function saveQuestionEdit() {
            const form = document.getElementById('editQuestionForm');
            const btn = document.getElementById('btnSaveQuestion');
            const spinner = btn.querySelector('.spinner-border');
            
            btn.disabled = true;
            spinner.classList.remove('d-none');

            try {
                const formData = new FormData(form);
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                const response = await fetch(`/Questions/Edit/${formData.get('Id')}`, {
                    method: 'POST',
                    body: formData,
                    headers: { 
                        'RequestVerificationToken': token,
                        'X-Requested-With': 'XMLHttpRequest' 
                    }
                });

                if (response.ok) {
                    Toast.show("Question updated!", "success");
                    location.reload();
                } else {
                    Toast.show("Failed to update question. Check inputs.", "error");
                }
            } catch (err) {
                console.error(err);
                Toast.show("Error updating question", "error");
            } finally {
                btn.disabled = false;
                spinner.classList.add('d-none');
            }
        }

        const answerForm = document.getElementById('answerForm');
        const answerErrorContainer = document.getElementById('answerValidationErrors');
        const btnPostAnswer = document.getElementById('btnPostAnswer');

        answerForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btnSpinner = btnPostAnswer.querySelector('.spinner-border');
            btnPostAnswer.disabled = true;
            btnSpinner.classList.remove('d-none');

            const formData = new FormData(this);
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': token,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    Toast.show("Answer posted successfully!", "success");
                    this.reset();
                    // If real-time broadcast is slow or fails, reload to show the answer
                    setTimeout(() => {
                        if (document.getElementById('answersList').children.length === 0) {
                             location.reload();
                        }
                    }, 1000);
                } else {
                    let errorMessage = "Failed to post answer";
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || (errorData.Content ? errorData.Content[0] : errorMessage);
                    } catch (pErr) {
                         // Likely HTML response (e.g. 500)
                         const rawText = await response.text();
                         console.error("Server returned non-JSON error:", rawText.substring(0, 500));
                    }
                    Toast.show(errorMessage, "error");
                }
            } catch (err) {
                console.error(err);
                Toast.show("An unexpected error occurred", "error");
            } finally {
                btnPostAnswer.disabled = false;
                btnSpinner.classList.add('d-none');
            }
        });
        function confirmDeleteAnswer(qId, aId) {
            window.Modal.confirm(
                'Delete Answer?',
                'Are you sure you want to delete this answer? This action cannot be undone.',
                'Delete Permanently'
            ).then((result) => {
                if (result.isConfirmed) {
                    performDeleteAnswer(qId, aId);
                }
            });
        }

        async function performDeleteAnswer(qId, aId) {
            const formData = new FormData();
            formData.append('questionId', qId);
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            
            try {
                const response = await fetch(`/Answers/Delete/${aId}`, {
                    method: 'POST',
                    body: formData,
                    headers: { 
                        'RequestVerificationToken': token,
                        'X-Requested-With': 'XMLHttpRequest' 
                    }
                });
                
                if (response.ok) {
                    Toast.show("Answer deleted!", "success");
                    location.reload();
                } else {
                    Toast.show("Failed to delete answer", "error");
                }
            } catch (err) {
                console.error(err);
                Toast.show("Error deleting answer", "error");
            }
        }
    </script>
}