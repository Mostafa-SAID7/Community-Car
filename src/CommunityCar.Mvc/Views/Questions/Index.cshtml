@model CommunityCar.Domain.Base.PagedResult<CommunityCar.Domain.DTOs.Community.QuestionDto>
@{
    ViewData["Title"] = "Questions & Answers";
    var currentTag = ViewBag.CurrentTag as string;
    var isResolved = ViewBag.IsResolved as bool?;
    var sortBy = ViewBag.SortBy as string ?? "recent";
    var searchTerm = ViewBag.SearchTerm as string;
}

@section RightSidebar {
    <partial name="Sidebars/_RightSidebar_QA" />
}

@section Styles {
    <style>
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            backdrop-filter: blur(2px);
            border-radius: var(--radius-xl);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .question-list-wrapper {
            position: relative;
            min-height: 200px;
        }
        
        /* Fade transition for list content */
        #question-list-container {
            transition: opacity 0.2s ease;
        }
        #question-list-container.fading {
            opacity: 0.5;
        }
    </style>
}


@{
    ViewData["HeaderTitle"] = "Questions & Answers";
    ViewData["HeaderDescription"] = "Ask questions and get answers from the community";
    ViewData["HeaderIcon"] = "fas fa-question-circle";
    
    if (User.Identity?.IsAuthenticated == true)
    {
        var createUrl = Url.Action("Create");
        var myQuestionsUrl = Url.Action("MyQuestions");
        var actionsHtml = "<div class='d-flex gap-2 flex-wrap'>" +
                          "<a href='" + createUrl + "' class='btn btn-light'>" +
                          "<i class='fas fa-plus-circle me-2'></i>Ask Question" +
                          "</a>" +
                          "<a href='" + myQuestionsUrl + "' class='btn btn-light'>" +
                          "<i class='fas fa-user me-2'></i>My Questions" +
                          "</a>" +
                          "</div>";
        ViewData["HeaderActions"] = Html.Raw(actionsHtml);
    }
    else
    {
        var loginUrl = Url.Action("Login", "Account", new { area = "Identity" });
        var actionsHtml = "<a href='" + loginUrl + "' class='btn btn-light'>" +
                          "<i class='fas fa-sign-in-alt me-2'></i>Login to Ask" +
                          "</a>";
        ViewData["HeaderActions"] = Html.Raw(actionsHtml);
    }
}

<partial name="_InnerPageHeader" />

<!-- Sort Tabs -->
<div class="sort-tabs" id="sort-tabs">
    <a href="#" data-sort="recent" class="sort-tab @(sortBy == "recent" ? "active" : "")">
        <i class="fas fa-clock"></i> Recent
    </a>
    <a href="#" data-sort="popular" class="sort-tab @(sortBy == "popular" ? "active" : "")">
        <i class="fas fa-fire"></i> Popular
    </a>
    <a href="#" data-sort="unanswered" class="sort-tab @(sortBy == "unanswered" ? "active" : "")">
        <i class="fas fa-question"></i> Unanswered
    </a>
    <a href="#" data-sort="votes" class="sort-tab @(sortBy == "votes" ? "active" : "")">
        <i class="fas fa-arrow-up"></i> Most Votes
    </a>
</div>

<!-- Filters -->
<div class="filter-card card mb-4">
    <div class="card-body">
        <form id="filter-form" asp-action="Index" method="get" class="row g-3">
            <input type="hidden" name="sortBy" id="sortByInput" value="@sortBy" />
            <input type="hidden" name="page" id="pageInput" value="@Model.PageNumber" />
            <input type="hidden" name="categoryId" value="@ViewBag.CurrentCategoryId" />
            
            <div class="col-md-5">
                <label class="form-label fw-bold small text-secondary">
                    <i class="fas fa-search me-1"></i>Search
                </label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" name="searchTerm" id="searchInput" class="form-control border-start-0 ps-0" 
                           placeholder="Search questions..." value="@searchTerm" autocomplete="off" />
                </div>
            </div>
            
            <div class="col-md-3">
                <label class="form-label fw-bold small text-secondary">
                    <i class="fas fa-tag me-1"></i>Tag
                </label>
                <input type="text" name="tag" id="tagInput" class="form-control" placeholder="Filter by tag" value="@currentTag" />
            </div>
            
            <div class="col-md-3">
                <label class="form-label fw-bold small text-secondary">
                    <i class="fas fa-filter me-1"></i>Status
                </label>
                <select name="isResolved" id="statusInput" class="form-select">
                    <option value="">All Questions</option>
                    <option value="false" selected="@(isResolved == false)">Open</option>
                    <option value="true" selected="@(isResolved == true)">Resolved</option>
                </select>
            </div>
            
            <div class="col-md-1 d-flex align-items-end">
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary w-100" title="Clear Filters">
                    <i class="fas fa-times"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<div class="question-list-wrapper">
    <div class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <div id="question-list-container">
        <partial name="_QuestionList" model="Model" />
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            let searchTimeout;
            const $container = $('#question-list-container');
            const $loading = $('.loading-overlay');
            const $form = $('#filter-form');
            
            // Function to fetch results
            function fetchResults() {
                // Show loading state
                $loading.addClass('active');
                $container.addClass('fading');
                
                // Get form data
                const formData = $form.serialize();
                
                // Update URL
                const newUrl = `${window.location.pathname}?${formData}`;
                window.history.pushState({ path: newUrl }, '', newUrl);
                
                // AJAX Request
                $.get(newUrl, function(data) {
                    $container.html(data);
                    
                    // Smooth scroll to top of list if we changed pages
                    // (Optional: logic to detect if it was a page change vs filter change)
                    
                }).fail(function() {
                    toastr.error('Failed to load questions');
                }).always(function() {
                    $loading.removeClass('active');
                    $container.removeClass('fading');
                });
            }

            // Live Search (Debounced)
            $('#searchInput, #tagInput').on('input', function() {
                clearTimeout(searchTimeout);
                $('#pageInput').val(1); // Reset to page 1
                searchTimeout = setTimeout(fetchResults, 500);
            });

            // Status Filter Change
            $('#statusInput').on('change', function() {
                $('#pageInput').val(1);
                fetchResults();
            });

            // Sort Tabs
            $('.sort-tab').on('click', function(e) {
                e.preventDefault();
                
                // Update active state
                $('.sort-tab').removeClass('active');
                $(this).addClass('active');
                
                // Update hidden input
                const sortBy = $(this).data('sort');
                $('#sortByInput').val(sortBy);
                $('#pageInput').val(1);
                
                fetchResults();
            });

            // Pagination (Delegated event for dynamic content)
            $(document).on('click', '.pagination .page-link', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                
                if (page) {
                    $('#pageInput').val(page);
                    fetchResults();
                    // Scroll to top of list
                    $('html, body').animate({
                        scrollTop: $('.sort-tabs').offset().top - 100
                    }, 300);
                }
            });

            // Handle browser back/forward buttons
            window.onpopstate = function(event) {
                if (event.state) {
                    location.reload(); // Simplest way to ensure correct state
                }
            };

            // SignalR Real-time Updates
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/questionHub")
                .withAutomaticReconnect()
                .build();

            connection.on("ReceiveQuestion", (question) => {
                const sortBy = $('#sortByInput').val();
                // If on first page and sorted by recent, refresh
                if ($('#pageInput').val() == 1 && (sortBy === 'recent' || sortBy === 'created')) {
                     toastr.info('New question received!');
                     fetchResults(); 
                }
            });

            connection.on("QuestionScoreUpdated", ({ questionId, newScore }) => {
                const $card = $(`.question-card[data-question-id="${questionId}"]`);
                if ($card.length) {
                    const $voteCount = $card.find('.question-stats .stat-item:first-child .stat-number');
                    $voteCount.text(newScore);
                    $voteCount.addClass('text-primary');
                    
                    // Also animate the icon or card slightly
                    $card.addClass('border-primary');
                    setTimeout(() => {
                        $voteCount.removeClass('text-primary');
                        $card.removeClass('border-primary');
                    }, 2000);
                }
            });
            
            connection.on("QuestionMarkedResolved", ({ questionId, isResolved }) => {
                const $card = $(`.question-card[data-question-id="${questionId}"]`);
                if ($card.length) {
                    // Update UI simply by refreshing if visible, or implement specific DOM manipulation
                    // For now, refreshing is safer to ensure correct badge state
                    fetchResults();
                }
            });

            connection.start().catch(err => console.error("SignalR Connection Error: ", err));

        });
    </script>
}
