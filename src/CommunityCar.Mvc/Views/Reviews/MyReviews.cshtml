@model CommunityCar.Domain.Base.PagedResult<CommunityCar.Domain.DTOs.Community.ReviewDto>
@{
    ViewData["Title"] = "My Reviews";
}

@section Styles {
    }

@{
    ViewData["HeaderTitle"] = "My Reviews";
    ViewData["HeaderDescription"] = "Manage and track your reviews";
    ViewData["HeaderIcon"] = "fas fa-user-edit";
    
    var createUrl = Url.Action("Create");
    var actionsHtml = "<a href='" + createUrl + "' class='btn btn-light'>" +
                      "<i class='fas fa-plus-circle me-2'></i>Write New Review" +
                      "</a>";
    ViewData["HeaderActions"] = Html.Raw(actionsHtml);
}

<partial name="_InnerPageHeader" />

<div class="container">
    @if (Model.Items.Any())
    {
        <div class="row">
            <div class="col-12">
                <div class="mb-3">
                    <h5 class="text-muted">
                        <i class="fas fa-list me-2"></i>Total Reviews: <strong>@Model.TotalCount</strong>
                    </h5>
                </div>
                
                @foreach (var review in Model.Items)
                {
                    <div class="card review-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-start mb-2 flex-wrap gap-2">
                                        <div class="star-rating me-2">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="fas fa-star @(i <= review.Rating ? "" : "text-muted")"></i>
                                            }
                                        </div>
                                        <span class="badge bg-primary">@review.TypeName</span>
                                        @* Status Badge *@
                                        @if (review.Status == CommunityCar.Domain.Enums.Community.reviews.ReviewStatus.Pending)
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock me-1"></i>Pending
                                            </span>
                                        }
                                        else if (review.Status == CommunityCar.Domain.Enums.Community.reviews.ReviewStatus.Approved)
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i>Approved
                                            </span>
                                        }
                                        else if (review.Status == CommunityCar.Domain.Enums.Community.reviews.ReviewStatus.Rejected)
                                        {
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times-circle me-1"></i>Rejected
                                            </span>
                                        }
                                        else if (review.Status == CommunityCar.Domain.Enums.Community.reviews.ReviewStatus.Flagged)
                                        {
                                            <span class="badge bg-danger">
                                                <i class="fas fa-flag me-1"></i>Flagged
                                            </span>
                                        }
                                        @if (review.IsVerifiedPurchase)
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i>Verified
                                            </span>
                                        }
                                    </div>
                                    
                                    <h4 class="mb-2">
                                        <a href="@Url.Action("Details", new { slug = review.Slug })" 
                                           class="text-decoration-none text-dark">
                                            @review.Title
                                        </a>
                                    </h4>
                                    
                                    <p class="text-muted mb-2">
                                        @(review.Content?.Length > 200 ? review.Content.Substring(0, 200) + "..." : review.Content)
                                    </p>
                                    
                                    @if (!string.IsNullOrEmpty(review.Pros) || !string.IsNullOrEmpty(review.Cons))
                                    {
                                        <div class="small">
                                            @if (!string.IsNullOrEmpty(review.Pros))
                                            {
                                                <div class="text-success mb-1">
                                                    <i class="fas fa-plus-circle me-1"></i>
                                                    <strong>Pros:</strong> @(review.Pros.Length > 80 ? review.Pros.Substring(0, 80) + "..." : review.Pros)
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(review.Cons))
                                            {
                                                <div class="text-danger">
                                                    <i class="fas fa-minus-circle me-1"></i>
                                                    <strong>Cons:</strong> @(review.Cons.Length > 80 ? review.Cons.Substring(0, 80) + "..." : review.Cons)
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="text-md-end">
                                        <div class="mb-3">
                                            <small class="text-muted d-block">
                                                <i class="fas fa-calendar me-1"></i>
                                                @review.CreatedAt.ToString("MMM dd, yyyy")
                                            </small>
                                            <small class="text-muted d-block">
                                                <i class="fas fa-thumbs-up me-1"></i>
                                                @review.HelpfulCount helpful
                                            </small>
                                        </div>
                                        
                                        <div class="btn-group-vertical gap-2" role="group">
                                            <a asp-action="Details" asp-route-slug="@review.Slug" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye me-1"></i>View
                                            </a>
                                            <a asp-action="Edit" asp-route-id="@review.Id" 
                                               class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-edit me-1"></i>Edit
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger delete-review" 
                                                    data-review-id="@review.Id" data-review-title="@review.Title">
                                                <i class="fas fa-trash me-1"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                
                <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <nav aria-label="My reviews pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                                <a class="page-link" asp-action="MyReviews" asp-route-page="@(Model.PageNumber - 1)">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            </li>

                            @for (int i = Math.Max(1, Model.PageNumber - 2); i <= Math.Min(Model.TotalPages, Model.PageNumber + 2); i++)
                            {
                                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                    <a class="page-link" asp-action="MyReviews" asp-route-page="@i">@i</a>
                                </li>
                            }

                            <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                                <a class="page-link" asp-action="MyReviews" asp-route-page="@(Model.PageNumber + 1)">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                }
            </div>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="fas fa-star fa-4x text-muted mb-4"></i>
                <h4 class="text-muted mb-3">No Reviews Yet</h4>
                <p class="text-muted mb-4">You haven't written any reviews yet. Share your experience with the community!</p>
                <a asp-action="Create" class="btn btn-primary btn-lg">
                    <i class="fas fa-plus-circle me-2"></i>Write Your First Review
                </a>
            </div>
        </div>
    }
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this review?</p>
                <p class="fw-bold" id="reviewTitle"></p>
                <p class="text-danger small mb-0">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash me-2"></i>Delete Review
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            let reviewIdToDelete = null;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            
            // Handle delete button click
            $('.delete-review').on('click', function() {
                reviewIdToDelete = $(this).data('review-id');
                const reviewTitle = $(this).data('review-title');
                $('#reviewTitle').text(reviewTitle);
                deleteModal.show();
            });
            
            // Handle confirm delete
            $('#confirmDelete').on('click', function() {
                if (!reviewIdToDelete) return;
                
                const token = $('input[name="__RequestVerificationToken"]').val();
                
                $.ajax({
                    url: '@Url.Action("Delete", "Reviews")/' + reviewIdToDelete,
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': token
                    },
                    success: function(response) {
                        if (response.success) {
                            deleteModal.hide();
                            location.reload();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function() {
                        alert('Failed to delete review. Please try again.');
                    }
                });
            });
        });
    </script>
}
