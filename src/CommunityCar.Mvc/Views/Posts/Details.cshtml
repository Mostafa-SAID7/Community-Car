@model CommunityCar.Mvc.ViewModels.Post.PostDetailsViewModel
@using CommunityCar.Domain.Enums.Community.post

@{
    ViewData["Title"] = Model.Post.Title;
    var post = Model.Post;
    var currentUserId = ViewBag.CurrentUserId as Guid?;
    var isAuthor = post.IsAuthor;
    var friendshipStatus = ViewBag.FriendshipStatus as CommunityCar.Domain.Enums.Community.friends.FriendshipStatus?;
    var isIncoming = ViewBag.IsIncomingRequest as bool? ?? false;
}
@using CommunityCar.Domain.Enums.Community.friends

@section Styles {
    <style>
        .post-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #4a5568;
        }
        .post-meta {
            font-size: 0.9rem;
            color: #718096;
        }
        .author-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }
        .tag-badge {
            background: #edf2f7;
            color: #4a5568;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            text-decoration: none;
            transition: all 0.2s;
            margin-right: 0.5rem;
            display: inline-block;
        }
        .tag-badge:hover {
            background: #e2e8f0;
            color: #2d3748;
        }
        .related-post-card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .related-post-card:hover {
            transform: translateY(-5px);
        }
    </style>
}

@{
    ViewData["HeaderTitle"] = post.Title;
    ViewData["HeaderIcon"] = post.Type switch {
        PostType.Image => "fas fa-image",
        PostType.Video => "fas fa-video",
        PostType.Link => "fas fa-link",
        _ => "fas fa-file-alt"
    };
    
    var actionsHtml = "<div class='d-flex gap-3 align-items-center'>" +
                      "<span><i class='fas fa-eye me-1'></i> " + post.ViewCount + "</span>" +
                      "<span><i class='fas fa-heart me-1'></i> " + post.LikeCount + "</span>" +
                      "<span><i class='fas fa-comment me-1'></i> " + post.CommentCount + "</span>" +
                      "</div>";
    ViewData["HeaderActions"] = Html.Raw(actionsHtml);
}

<partial name="_InnerPageHeader" />

<div class="container my-5">
    <div class="row">
        <div class="col-lg-8">
            <!-- Post Content -->
            <div class="card shadow-sm border-0 mb-4 rounded-4">
                <div class="card-body p-4 p-md-5">
                    <div class="d-flex align-items-center mb-4">
                        <img src="@(post.AuthorAvatar ?? "/images/default-avatar.svg")" alt="@post.AuthorName" class="author-avatar me-3">
                        <div>
                            <h6 class="mb-0 fw-bold">@post.AuthorName</h6>
                            <div class="post-meta">
                                <span>@post.CreatedAt.ToString("MMMM dd, yyyy")</span>
                                @if (post.GroupId.HasValue)
                                {
                                    <span class="mx-2">•</span>
                                    <a href="/Groups/Details/@post.GroupId" class="text-decoration-none">
                                        <i class="fas fa-users me-1"></i>In Community Group
                                    </a>
                                }
                            </div>
                        </div>
                        @if (isAuthor)
                        {
                            <div class="ms-auto">
                                <a asp-action="Edit" asp-route-id="@post.Id" class="btn btn-outline-primary btn-sm rounded-pill px-3">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </a>
                            </div>
                        }
                    </div>

                    @if (post.Type == PostType.Image && !string.IsNullOrEmpty(post.ImageUrl))
                    {
                        <img src="@post.ImageUrl" class="img-fluid rounded-4 mb-4 w-100" alt="@post.Title">
                    }
                    @if (post.Type == PostType.Video && !string.IsNullOrEmpty(post.VideoUrl))
                    {
                        <div class="ratio ratio-16x9 mb-4 rounded-4 overflow-hidden">
                            <iframe src="@post.VideoUrl" allowfullscreen></iframe>
                        </div>
                    }

                    <div class="post-content mb-4">
                        @Html.Raw(post.Content)
                    </div>

                    @if (!string.IsNullOrEmpty(post.Tags))
                    {
                        <div class="tags-container mb-4">
                            @foreach (var tag in post.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                            {
                                <a href="/Posts?tag=@tag.Trim()" class="tag-badge">#@tag.Trim()</a>
                            }
                        </div>
                    }

                    @if (post.Type == PostType.Link && !string.IsNullOrEmpty(post.LinkUrl))
                    {
                        <div class="card bg-light border-0 rounded-4 p-3 mb-4">
                            <div class="d-flex align-items-center">
                                <div class="p-3 bg-white rounded-circle me-3">
                                    <i class="fas fa-link text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">@post.LinkTitle</h6>
                                    <p class="small text-muted mb-2">@post.LinkDescription</p>
                                    <a href="@post.LinkUrl" target="_blank" class="btn btn-primary btn-sm rounded-pill px-3">
                                        Visit Link <i class="fas fa-external-link-alt ms-1 small"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="d-flex align-items-center pt-4 border-top">
                        <button class="btn @(post.IsLiked ? "btn-danger" : "btn-outline-danger") rounded-pill px-4 me-3" onclick="toggleLike('@post.Id')">
                            <i class="fas fa-heart me-2"></i>@(post.IsLiked ? "Liked" : "Like") (@post.LikeCount)
                        </button>
                        <button class="btn btn-outline-primary rounded-pill px-4" onclick="sharePost('@post.Id', '@post.Title')">
                            <i class="fas fa-share-alt me-2"></i>Share
                        </button>
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="comments-section mb-5">
                <h4 class="fw-bold mb-4">Comments (@Model.Comments.TotalCount)</h4>
                
                @if (User.Identity?.IsAuthenticated ?? false)
                {
                    <div class="card shadow-sm border-0 mb-4 rounded-4">
                        <div class="card-body p-4">
                            <form id="commentForm">
                                <input type="hidden" name="postId" value="@post.Id" />
                                <div class="mb-3">
                                    <textarea name="content" class="form-control rounded-4 border-light" rows="3" placeholder="Add a comment..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary rounded-pill px-4">Post Comment</button>
                            </form>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-light border rounded-4 p-4 text-center mb-4">
                        <p class="mb-3">Please login to join the conversation</p>
                        <a href="/Identity/Account/Login" class="btn btn-primary rounded-pill px-4">Login</a>
                    </div>
                }

                <div id="commentsContainer">
                    @if (Model.Comments.Items.Any())
                    {
                        @foreach (var comment in Model.Comments.Items)
                        {
                            <div class="d-flex mb-4">
                                <img src="@(comment.UserAvatar ?? "/images/default-avatar.svg")" alt="@comment.UserName" class="rounded-circle me-3" style="width: 40px; height: 40px;">
                                <div class="flex-grow-1">
                                    <div class="bg-light p-3 rounded-4">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="fw-bold small">@comment.UserName</span>
                                            <span class="text-muted smaller">@comment.CreatedAt.ToString("MMM dd, yyyy")</span>
                                        </div>
                                        <p class="mb-0 small">@comment.Content</p>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-comments fa-3x mb-3 opacity-25"></i>
                            <p>No comments yet. Be the first to share your thoughts!</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Author Block -->
            <div class="card shadow-sm border-0 mb-4 rounded-4 overflow-hidden">
                <div class="bg-primary p-3"></div>
                <div class="card-body p-4 text-center mt-n4">
                    <img src="@(post.AuthorAvatar ?? "/images/default-avatar.svg")" class="rounded-circle border border-4 border-white mb-3 shadow-sm" style="width: 80px; height: 80px; margin-top: -50px;">
                    <h5 class="fw-bold mb-1">@post.AuthorName</h5>
                    <p class="text-muted small mb-3">Community Contributor</p>
                    
                    <div class="d-flex flex-column gap-2 px-3">
                        <a href="@Url.Action("Index", "Profiles", new { area = "Identity", id = post.AuthorId })" class="btn btn-outline-primary btn-sm rounded-pill w-100">View Profile</a>
                        
                        @if (currentUserId.HasValue && !isAuthor)
                        {
                            @if (friendshipStatus == FriendshipStatus.None)
                            {
                                <form asp-controller="Friends" asp-action="SendRequest" method="post" class="ajax-add-friend-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="friendId" value="@post.AuthorId" />
                                    <button type="submit" class="btn btn-primary btn-sm rounded-pill w-100">
                                        <i class="fas fa-user-plus me-1"></i> Add Friend
                                    </button>
                                </form>
                            }
                            else if (friendshipStatus == FriendshipStatus.Pending)
                            {
                                if (isIncoming)
                                {
                                    <div class="d-flex gap-2">
                                        <form asp-controller="Friends" asp-action="AcceptRequest" method="post" class="ajax-accept-form flex-grow-1">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="friendId" value="@post.AuthorId" />
                                            <button type="submit" class="btn btn-success btn-sm rounded-pill w-100">
                                                <i class="fas fa-check me-1"></i> Accept
                                            </button>
                                        </form>
                                        <form asp-controller="Friends" asp-action="RejectRequest" method="post" class="ajax-reject-form flex-grow-1">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="friendId" value="@post.AuthorId" />
                                            <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill w-100">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </div>
                                }
                                else
                                {
                                    <button class="btn btn-secondary btn-sm rounded-pill w-100" disabled>
                                        <i class="fas fa-clock me-1"></i> Request Sent
                                    </button>
                                }
                            }
                            else if (friendshipStatus == FriendshipStatus.Accepted)
                            {
                                <button class="btn btn-success btn-sm rounded-pill w-100" disabled>
                                    <i class="fas fa-check-double me-1"></i> Friends
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- Related Posts -->
            <h5 class="fw-bold mb-3 ms-2">Related Content</h5>
            @foreach (var related in Model.RelatedPosts)
            {
                <div class="card related-post-card mb-3 rounded-4">
                    <div class="card-body p-3">
                        <div class="d-flex">
                            @if (!string.IsNullOrEmpty(related.ImageUrl))
                            {
                                <img src="@related.ImageUrl" class="rounded-3 me-3" style="width: 60px; height: 60px; object-fit: cover;">
                            }
                            else
                            {
                                <div class="bg-light rounded-3 d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                                    <i class="fas fa-file-alt text-muted opacity-50"></i>
                                </div>
                            }
                            <div class="flex-grow-1 overflow-hidden">
                                <h6 class="mb-1 text-truncate">
                                    <a href="/Posts/Details/@related.Slug" class="text-decoration-none text-dark">@related.Title</a>
                                </h6>
                                <p class="smaller text-muted mb-0">@related.CreatedAt.ToString("MMM dd") • @related.AuthorName</p>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/friends.js"></script>
    <script>
        function toggleLike(postId) {
            const url = CultureHelper.buildUrl('Posts/ToggleLike/' + postId);
            $.post(url, function(res) {
                if (res.success) location.reload();
            });
        }

        function sharePost(postId, title) {
            if (navigator.share) {
                navigator.share({
                    title: title,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert('Link copied to clipboard!');
            }
        }

        $('#commentForm').submit(function(e) {
            e.preventDefault();
            const data = $(this).serialize();
            const url = CultureHelper.addCultureToUrl('/Posts/AddComment');
            $.post(url, data, function(res) {
                if (res.success) location.reload();
            });
        });
    </script>
}
