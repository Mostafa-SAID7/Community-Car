@model CommunityCar.Domain.Base.PagedResult<CommunityCar.Domain.DTOs.Community.PostDto>
@{
    ViewData["Title"] = "Community Posts";
    var currentType = ViewBag.CurrentType as CommunityCar.Domain.Enums.Community.post.PostType?;
    var groupId = ViewBag.GroupId as Guid?;
    var postTypes = ViewBag.PostTypes as Array;
}

@section Styles {
    <link rel="stylesheet" href="~/css/components/cards.css" />
    <link rel="stylesheet" href="~/css/pages/posts.css" />
}

@{
    ViewData["HeaderTitle"] = "Community Posts";
    ViewData["HeaderDescription"] = "Share your thoughts, stories, and experiences with fellow car enthusiasts";
    ViewData["HeaderIcon"] = "fas fa-edit";
    
    if (User.Identity?.IsAuthenticated ?? false)
    {
        var createUrl = Url.Action("Create");
        var myPostsUrl = Url.Action("MyPosts");
        var actionsHtml = "<div class='d-flex gap-2 flex-wrap'>" +
                          "<a href='" + createUrl + "' class='btn btn-light'>" +
                          "<i class='fas fa-plus-circle me-2'></i>Create Post" +
                          "</a>" +
                          "<a href='" + myPostsUrl + "' class='btn btn-light'>" +
                          "<i class='fas fa-user-edit me-2'></i>My Posts" +
                          "</a>" +
                          "</div>";
        ViewData["HeaderActions"] = Html.Raw(actionsHtml);
    }
}

<partial name="_InnerPageHeader" />

<div class="container posts-container">
    <!-- Search and Filters Section -->
    <div class="card filter-card mb-4">
        <div class="card-body">
            <!-- Search Bar -->
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <form method="get" asp-action="Index" asp-controller="Posts" class="search-form">
                        <div class="search-wrapper position-relative">
                            <input type="text" 
                                   name="search"
                                   id="postSearchInput" 
                                   class="form-control form-control-lg ps-5" 
                                   placeholder="Search posts by title, content, or tags..."
                                   value="@Context.Request.Query["search"]"
                                   autocomplete="off">
                            <i class="fas fa-search search-icon"></i>
                            @if (currentType != null)
                            {
                                <input type="hidden" name="type" value="@currentType" />
                            }
                            <button type="submit" class="btn btn-purple position-absolute end-0 top-50 translate-middle-y me-2">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Type Filters -->
            <div class="d-flex flex-wrap gap-2 align-items-center">
                <span class="fw-bold me-2 filter-label">
                    <i class="fas fa-filter me-1"></i>Post Type:
                </span>
                <a href="@Url.Action("Index", "Posts")" 
                   class="btn btn-sm @(currentType == null ? "btn-purple active" : "btn-outline-purple")">
                    <i class="fas fa-th me-1"></i>All Types
                </a>
                @if (postTypes != null)
                {
                    @foreach (var type in postTypes)
                    {
                        var typeValue = (CommunityCar.Domain.Enums.Community.post.PostType)type;
                        <a href="@Url.Action("Index", "Posts", new { type = typeValue })" 
                           class="btn btn-sm @(currentType == typeValue ? "btn-purple active" : "btn-outline-purple")">
                            @typeValue.ToString()
                        </a>
                    }
                }
                <div class="ms-auto">
                    <a asp-action="Featured" 
                       class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-star me-1"></i>Featured
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Count -->
    <div class="results-info mb-3">
        <span id="resultsCount" class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Showing <strong>@Model.Items.Count()</strong> of <strong>@Model.TotalCount</strong> posts
        </span>
    </div>

    <!-- Posts Grid -->
    <div id="postsGrid" class="row g-4 mb-4">
        @if (Model.Items.Any())
        {
            @foreach (var post in Model.Items)
            {
                <div class="col-xl-4 col-lg-6 col-md-6 col-sm-12 post-item">
                    <div class="content-card">
                        @if ((post.Type == CommunityCar.Domain.Enums.Community.post.PostType.Image && !string.IsNullOrEmpty(post.ImageUrl)) || 
                             (post.Type == CommunityCar.Domain.Enums.Community.post.PostType.Video && !string.IsNullOrEmpty(post.VideoUrl)))
                        {
                            <div class="content-card-image-wrapper">
                                @if (post.IsPinned)
                                {
                                    <span class="card-badge card-badge-top-left card-badge-warning">
                                        <i class="fas fa-thumbtack me-1"></i>Pinned
                                    </span>
                                }
                                <span class="card-badge card-badge-top-right card-badge-primary">
                                    @post.Type
                                </span>
                                
                                @* Display image or video based on post type *@
                                @if (post.Type == CommunityCar.Domain.Enums.Community.post.PostType.Image && !string.IsNullOrEmpty(post.ImageUrl))
                                {
                                    <img src="@post.ImageUrl" 
                                         alt="@post.Title" 
                                         class="content-card-image" 
                                         loading="lazy" />
                                }
                                else if (post.Type == CommunityCar.Domain.Enums.Community.post.PostType.Video && !string.IsNullOrEmpty(post.VideoUrl))
                                {
                                    @if (post.VideoUrl.Contains("youtube.com") || post.VideoUrl.Contains("youtu.be"))
                                    {
                                        @* YouTube video thumbnail *@
                                        var videoId = post.VideoUrl.Contains("youtu.be") 
                                            ? post.VideoUrl.Split('/').Last().Split('?').First()
                                            : System.Web.HttpUtility.ParseQueryString(new Uri(post.VideoUrl).Query).Get("v");
                                        <div class="video-thumbnail-wrapper">
                                            <img src="https://img.youtube.com/vi/@videoId/maxresdefault.jpg" 
                                                 alt="@post.Title" 
                                                 class="content-card-image" 
                                                 loading="lazy" />
                                            <div class="video-play-overlay">
                                                <i class="fas fa-play-circle"></i>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        @* Direct video file *@
                                        <div class="video-thumbnail-wrapper">
                                            <video class="content-card-image" preload="metadata">
                                                <source src="@post.VideoUrl#t=0.1" type="video/mp4">
                                            </video>
                                            <div class="video-play-overlay">
                                                <i class="fas fa-play-circle"></i>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        }
                        <div class="content-card-body">
                            <div class="content-card-meta">
                                <span class="author-info">
                                    <i class="fas fa-user me-1"></i>@post.AuthorName
                                </span>
                                <span class="mx-2">â€¢</span>
                                <span class="date-info">
                                    <i class="fas fa-calendar me-1"></i>@post.CreatedAt.ToString("MMM dd, yyyy")
                                </span>
                            </div>
                            <h5 class="content-card-title">
                                <a href="@Url.Action("Details", "Posts", new { slug = post.Slug })">
                                    @post.Title
                                </a>
                            </h5>
                            <p class="content-card-content">
                                @(post.Content?.Length > 120 ? post.Content.Substring(0, 120) + "..." : post.Content)
                            </p>
                            @if (!string.IsNullOrEmpty(post.CategoryName))
                            {
                                <div class="mb-2">
                                    <span class="badge bg-primary">
                                        <i class="fas fa-folder me-1"></i>@post.CategoryName
                                    </span>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(post.Tags))
                            {
                                <div class="card-tags">
                                    @foreach (var tag in post.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries).Take(3))
                                    {
                                        <span class="card-tag">#@tag.Trim()</span>
                                    }
                                </div>
                            }
                            <div class="content-card-footer">
                                <div class="card-stats">
                                    <span class="card-stat-item" title="Views">
                                        <i class="fas fa-eye"></i>
                                        <span>@post.ViewCount</span>
                                    </span>
                                    <span class="card-stat-item" title="Likes">
                                        <i class="fas fa-heart"></i>
                                        <span>@post.LikeCount</span>
                                    </span>
                                    <span class="card-stat-item" title="Comments">
                                        <i class="fas fa-comment"></i>
                                        <span>@post.CommentCount</span>
                                    </span>
                                    <span class="card-stat-item" title="Shares">
                                        <i class="fas fa-share"></i>
                                        <span>@post.ShareCount</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="empty-state-card">
                    <i class="fas fa-edit"></i>
                    <h4>No Posts Found</h4>
                    <p>
                        @if (currentType != null)
                        {
                            <text>No posts found with the selected type.</text>
                        }
                        else
                        {
                            <text>Be the first to share your story with the community!</text>
                        }
                    </p>
                    @if (User.Identity?.IsAuthenticated ?? false)
                    {
                        <a asp-action="Create" class="btn btn-purple text-white">
                            <i class="fas fa-plus-circle me-2"></i>Create First Post
                        </a>
                    }
                    else
                    {
                        <a asp-area="Identity" asp-controller="Account" asp-action="Login" class="btn btn-purple text-white">
                            <i class="fas fa-sign-in-alt me-2"></i>Login to Create Posts
                        </a>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Pagination -->
    @if (Model.TotalPages > 1)
    {
        <nav aria-label="Posts pagination" class="mt-5" id="paginationNav">
            <ul class="pagination justify-content-center flex-wrap">
                <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                    <a class="page-link" 
                       href="@Url.Action("Index", "Posts", new { page = Model.PageNumber - 1, type = currentType, groupId = groupId })"
                       data-page="@(Model.PageNumber - 1)">
                        <i class="fas fa-chevron-left"></i> <span class="d-none d-sm-inline">Previous</span>
                    </a>
                </li>

                @for (int i = Math.Max(1, Model.PageNumber - 2); i <= Math.Min(Model.TotalPages, Model.PageNumber + 2); i++)
                {
                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                        <a class="page-link" 
                           href="@Url.Action("Index", "Posts", new { page = i, type = currentType, groupId = groupId })"
                           data-page="@i">
                            @i
                        </a>
                    </li>
                }

                <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                    <a class="page-link" 
                       href="@Url.Action("Index", "Posts", new { page = Model.PageNumber + 1, type = currentType, groupId = groupId })"
                       data-page="@(Model.PageNumber + 1)">
                        <span class="d-none d-sm-inline">Next</span> <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    }
</div>

@section Scripts {
    <script src="~/js/pages/posts.js"></script>
}
