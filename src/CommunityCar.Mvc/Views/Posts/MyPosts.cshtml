@model CommunityCar.Domain.Base.PagedResult<CommunityCar.Domain.DTOs.Community.PostDto>

@{
    ViewData["Title"] = "My Posts";
    ViewData["HeaderTitle"] = "My Posts";
    ViewData["HeaderDescription"] = "Manage your shared stories and experiences";
    ViewData["HeaderIcon"] = "fas fa-user-edit";
    
    var createUrl = Url.Action("Create");
    var actionsHtml = "<a href='" + createUrl + "' class='btn btn-light'>" +
                      "<i class='fas fa-plus-circle me-2'></i>Create New Post" +
                      "</a>";
    ViewData["HeaderActions"] = Html.Raw(actionsHtml);
}

@section Styles {
    <link rel="stylesheet" href="~/css/components/cards.css" />
    <link rel="stylesheet" href="~/css/pages/posts.css" />
}

<partial name="_InnerPageHeader" />

<div class="container posts-container">
    @if (Model.Items.Any())
    {
        <div class="row g-4 mb-4">
            @foreach (var post in Model.Items)
            {
                <div class="col-xl-4 col-lg-6 col-md-6 col-sm-12 post-item">
                    <div class="content-card">
                        <div class="content-card-image-wrapper">
                            @if (post.IsPinned)
                            {
                                <span class="card-badge card-badge-top-left card-badge-warning">
                                    <i class="fas fa-thumbtack me-1"></i>Pinned
                                </span>
                            }
                            @if (post.IsFeatured)
                            {
                                <span class="card-badge card-badge-top-right card-badge-warning">
                                    <i class="fas fa-star me-1"></i>Featured
                                </span>
                            }
                            else
                            {
                                <span class="card-badge card-badge-top-right card-badge-primary">
                                    @post.Type
                                </span>
                            }
                            @* Display image or video based on post type *@
                            @if (post.Type == CommunityCar.Domain.Enums.Community.post.PostType.Image && !string.IsNullOrEmpty(post.ImageUrl))
                            {
                                <img src="@post.ImageUrl" 
                                     alt="@post.Title" 
                                     class="content-card-image" 
                                     loading="lazy" />
                            }
                            else if (post.Type == CommunityCar.Domain.Enums.Community.post.PostType.Video && !string.IsNullOrEmpty(post.VideoUrl))
                            {
                                @if (post.VideoUrl.Contains("youtube.com") || post.VideoUrl.Contains("youtu.be"))
                                {
                                    @* YouTube video thumbnail *@
                                    var videoId = post.VideoUrl.Contains("youtu.be") 
                                        ? post.VideoUrl.Split('/').Last().Split('?').First()
                                        : System.Web.HttpUtility.ParseQueryString(new Uri(post.VideoUrl).Query).Get("v");
                                    <div class="video-thumbnail-wrapper">
                                        <img src="https://img.youtube.com/vi/@videoId/maxresdefault.jpg" 
                                             alt="@post.Title" 
                                             class="content-card-image" 
                                             loading="lazy" />
                                        <div class="video-play-overlay">
                                            <i class="fas fa-play-circle"></i>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    @* Direct video file *@
                                    <div class="video-thumbnail-wrapper">
                                        <video class="content-card-image" preload="metadata">
                                            <source src="@post.VideoUrl#t=0.1" type="video/mp4">
                                        </video>
                                        <div class="video-play-overlay">
                                            <i class="fas fa-play-circle"></i>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                @* Default placeholder *@
                                <img src="/images/post-placeholder.jpg" 
                                     alt="@post.Title" 
                                     class="content-card-image" 
                                     loading="lazy" />
                            }
                        </div>
                        <div class="content-card-body">
                            <div class="content-card-meta">
                                <span class="date-info">
                                    <i class="fas fa-calendar me-1"></i>@post.CreatedAt.ToString("MMM dd, yyyy")
                                </span>
                                <span class="mx-2">â€¢</span>
                                <span class="status-info">
                                    <i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i>@post.Status
                                </span>
                            </div>
                            <h5 class="content-card-title">
                                <a href="@Url.Action("Details", "Posts", new { slug = post.Slug })">
                                    @post.Title
                                </a>
                            </h5>
                            <p class="content-card-content">
                                @(post.Content?.Length > 120 ? post.Content.Substring(0, 120) + "..." : post.Content)
                            </p>
                            @if (!string.IsNullOrEmpty(post.CategoryName))
                            {
                                <div class="mb-2">
                                    <span class="badge bg-primary">
                                        <i class="fas fa-folder me-1"></i>@post.CategoryName
                                    </span>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(post.Tags))
                            {
                                <div class="card-tags">
                                    @foreach (var tag in post.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries).Take(3))
                                    {
                                        <span class="card-tag">#@tag.Trim()</span>
                                    }
                                </div>
                            }
                            <div class="content-card-footer">
                                <div class="card-stats">
                                    <span class="card-stat-item" title="Views">
                                        <i class="fas fa-eye"></i>
                                        <span>@post.ViewCount</span>
                                    </span>
                                    <span class="card-stat-item" title="Likes">
                                        <i class="fas fa-heart"></i>
                                        <span>@post.LikeCount</span>
                                    </span>
                                    <span class="card-stat-item" title="Comments">
                                        <i class="fas fa-comment"></i>
                                        <span>@post.CommentCount</span>
                                    </span>
                                    <span class="card-stat-item" title="Shares">
                                        <i class="fas fa-share"></i>
                                        <span>@post.ShareCount</span>
                                    </span>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-ghost dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow-lg">
                                        <li>
                                            <a class="dropdown-item" href="@Url.Action("Details", "Posts", new { slug = post.Slug })">
                                                <i class="fas fa-eye me-2 text-primary"></i>View
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="@Url.Action("Edit", "Posts", new { id = post.Id })">
                                                <i class="fas fa-edit me-2 text-info"></i>Edit
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" onclick="deletePost('@post.Id'); return false;">
                                                <i class="fas fa-trash me-2"></i>Delete
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Posts pagination" class="mt-5" id="paginationNav">
                <ul class="pagination justify-content-center flex-wrap">
                    <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                        <a class="page-link" 
                           href="@Url.Action("MyPosts", "Posts", new { page = Model.PageNumber - 1 })"
                           data-page="@(Model.PageNumber - 1)">
                            <i class="fas fa-chevron-left"></i> <span class="d-none d-sm-inline">Previous</span>
                        </a>
                    </li>

                    @for (int i = Math.Max(1, Model.PageNumber - 2); i <= Math.Min(Model.TotalPages, Model.PageNumber + 2); i++)
                    {
                        <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                            <a class="page-link" 
                               href="@Url.Action("MyPosts", "Posts", new { page = i })"
                               data-page="@i">
                                @i
                            </a>
                        </li>
                    }

                    <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                        <a class="page-link" 
                           href="@Url.Action("MyPosts", "Posts", new { page = Model.PageNumber + 1 })"
                           data-page="@(Model.PageNumber + 1)">
                            <span class="d-none d-sm-inline">Next</span> <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        }
    }
    else
    {
        <div class="row">
            <div class="col-12">
                <div class="empty-state-card">
                    <i class="fas fa-inbox"></i>
                    <h4>No Posts Yet</h4>
                    <p>You haven't created any posts yet. Start sharing your thoughts with the community!</p>
                    <a asp-action="Create" class="btn btn-purple text-white">
                        <i class="fas fa-plus-circle me-2"></i>Create Your First Post
                    </a>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="~/js/pages/posts.js"></script>
}
