@model List<CommunityCar.Domain.DTOs.Communications.ChatMessageDto>
@{
    ViewData["Title"] = "Chat";
    var otherUserId = ViewBag.OtherUserId as Guid?;
    var conversations = ViewBag.Conversations as List<CommunityCar.Domain.DTOs.Communications.ChatConversationDto> ?? new List<CommunityCar.Domain.DTOs.Communications.ChatConversationDto>();
    var otherUser = Model.FirstOrDefault();
}

<div class="container-fluid py-4">
    <div class="row">
        <!-- Conversations Sidebar -->
        <div class="col-md-4 col-lg-3 mb-3">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>Conversations
                    </h5>
                </div>
                <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                    <div class="list-group list-group-flush">
                        @foreach (var conversation in conversations)
                        {
                            <a href="@Url.Action("Conversation", new { userId = conversation.UserId })" 
                               class="list-group-item list-group-item-action @(conversation.UserId == otherUserId ? "active" : "")"
                               data-user-id="@conversation.UserId">
                                <div class="d-flex align-items-center">
                                    <div class="position-relative me-2">
                                        @if (!string.IsNullOrEmpty(conversation.ProfilePicture))
                                        {
                                            <img src="@conversation.ProfilePicture" 
                                                 alt="@conversation.UserName" 
                                                 class="rounded-circle" 
                                                 style="width: 40px; height: 40px; object-fit: cover;">
                                        }
                                        else
                                        {
                                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                                 style="width: 40px; height: 40px; font-size: 0.9rem;">
                                                <span>@conversation.UserName.Substring(0, 1).ToUpper()</span>
                                            </div>
                                        }
                                        <span class="online-indicator position-absolute bottom-0 end-0 border border-white rounded-circle d-none" 
                                              style="width: 12px; height: 12px; background-color: #28a745;"></span>
                                    </div>
                                    <div class="flex-grow-1 text-truncate">
                                        <div class="fw-bold small">@conversation.UserName</div>
                                        <div class="typing-indicator text-muted small d-none">
                                            <i class="fas fa-ellipsis-h"></i> typing...
                                        </div>
                                        @if (conversation.UnreadCount > 0)
                                        {
                                            <span class="badge bg-danger rounded-pill">@conversation.UnreadCount</span>
                                        }
                                    </div>
                                </div>
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-8 col-lg-9">
            <div class="card">
                @if (otherUser != null)
                {
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex align-items-center">
                            @if (!string.IsNullOrEmpty(otherUser.SenderProfilePicture))
                            {
                                <img src="@otherUser.SenderProfilePicture" 
                                     alt="@otherUser.SenderName" 
                                     class="rounded-circle me-3" 
                                     style="width: 40px; height: 40px; object-fit: cover;">
                            }
                            else
                            {
                                <div class="rounded-circle bg-white text-primary d-flex align-items-center justify-content-center me-3" 
                                     style="width: 40px; height: 40px;">
                                    <span class="fw-bold">@otherUser.SenderName.Substring(0, 1).ToUpper()</span>
                                </div>
                            }
                            <div>
                                <h5 class="mb-0">@otherUser.SenderName</h5>
                                <small class="online-status d-none">Online</small>
                            </div>
                        </div>
                    </div>
                }

                <div class="card-body" style="height: 500px; overflow-y: auto;" id="chatMessages">
                    @if (Model == null || !Model.Any())
                    {
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-comment-slash fa-3x mb-3"></i>
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var message in Model)
                        {
                            var isMine = message.SenderId.ToString() == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                            <div class="mb-3 d-flex @(isMine ? "justify-content-end" : "justify-content-start")" data-message-id="@message.Id">
                                <div class="@(isMine ? "text-end" : "text-start")" style="max-width: 70%;">
                                    @if (!isMine)
                                    {
                                        <div class="small text-muted mb-1">@message.SenderName</div>
                                    }
                                    <div class="p-3 rounded @(isMine ? "bg-primary text-white" : "bg-light")">
                                        <p class="mb-1">@message.Content</p>
                                        <small class="@(isMine ? "text-white-50" : "text-muted")">
                                            @message.CreatedAt.ToString("HH:mm")
                                            @if (isMine && message.IsRead)
                                            {
                                                <i class="fas fa-check-double ms-1"></i>
                                            }
                                        </small>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="card-footer">
                    <div class="typing-indicator-other text-muted small mb-2 d-none">
                        <i class="fas fa-ellipsis-h"></i> @otherUser?.SenderName is typing...
                    </div>
                    <form id="sendMessageForm" class="d-flex gap-2">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="ReceiverId" value="@otherUserId" id="receiverId" />
                        <input type="text" 
                               name="Content" 
                               id="messageContent" 
                               class="form-control" 
                               placeholder="Type your message..." 
                               required 
                               maxlength="2000" />
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/dist/browser/signalr.min.js"></script>
    <script>
        $(document).ready(function() {
            const receiverId = $('#receiverId').val();
            let typingTimeout;
            let connection;

            // Initialize SignalR connection
            function initializeSignalR() {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/hubs/chat")
                    .withAutomaticReconnect()
                    .build();

                // Receive new message
                connection.on("ReceiveMessage", function(senderId, message, timestamp) {
                    if (senderId === receiverId) {
                        addMessageToChat(senderId, message, timestamp, false);
                        scrollToBottom();
                        
                        // Mark as read
                        $.post('@Url.Action("MarkConversationAsRead")/' + senderId);
                    }
                });

                // Message sent confirmation
                connection.on("MessageSent", function(receiverId, message, timestamp) {
                    // Message already added via AJAX response
                });

                // Message read receipt
                connection.on("MessageRead", function(messageId) {
                    $('[data-message-id="' + messageId + '"] .fa-check').removeClass('fa-check').addClass('fa-check-double');
                });

                // User online status
                connection.on("UserOnline", function(userId) {
                    updateOnlineStatus(userId, true);
                });

                connection.on("UserOffline", function(userId) {
                    updateOnlineStatus(userId, false);
                });

                // Typing indicators
                connection.on("UserTyping", function(userId) {
                    if (userId === receiverId) {
                        $('.typing-indicator-other').removeClass('d-none');
                    }
                });

                connection.on("UserStoppedTyping", function(userId) {
                    if (userId === receiverId) {
                        $('.typing-indicator-other').addClass('d-none');
                    }
                });

                // Start connection
                connection.start()
                    .then(function() {
                        console.log("SignalR connected");
                    })
                    .catch(function(err) {
                        console.error("SignalR connection error:", err);
                    });
            }

            // Initialize SignalR
            initializeSignalR();

            // Scroll to bottom of messages
            function scrollToBottom() {
                var chatMessages = $('#chatMessages');
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }
            scrollToBottom();

            // Add message to chat UI
            function addMessageToChat(senderId, content, timestamp, isMine) {
                const messageHtml = `
                    <div class="mb-3 d-flex ${isMine ? 'justify-content-end' : 'justify-content-start'}">
                        <div class="${isMine ? 'text-end' : 'text-start'}" style="max-width: 70%;">
                            <div class="p-3 rounded ${isMine ? 'bg-primary text-white' : 'bg-light'}">
                                <p class="mb-1">${content}</p>
                                <small class="${isMine ? 'text-white-50' : 'text-muted'}">
                                    ${new Date(timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
                $('#chatMessages').append(messageHtml);
            }

            // Update online status
            function updateOnlineStatus(userId, isOnline) {
                const userElement = $('[data-user-id="' + userId + '"]');
                if (isOnline) {
                    userElement.find('.online-indicator').removeClass('d-none');
                    if (userId === receiverId) {
                        $('.online-status').removeClass('d-none').text('Online');
                    }
                } else {
                    userElement.find('.online-indicator').addClass('d-none');
                    if (userId === receiverId) {
                        $('.online-status').addClass('d-none');
                    }
                }
            }

            // Send message
            $('#sendMessageForm').on('submit', function(e) {
                e.preventDefault();
                
                const content = $('#messageContent').val().trim();
                if (!content) return;

                const formData = $(this).serialize();
                
                $.ajax({
                    url: '@Url.Action("SendMessage")',
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            const message = response.message;
                            addMessageToChat(message.senderId, message.content, message.createdAt, true);
                            $('#messageContent').val('');
                            scrollToBottom();
                            
                            // Send via SignalR
                            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                                connection.invoke("SendMessage", receiverId, message.content);
                            }
                        } else {
                            alert('Failed to send message: ' + response.message);
                        }
                    },
                    error: function() {
                        alert('An error occurred while sending the message');
                    }
                });
            });

            // Typing indicator
            $('#messageContent').on('input', function() {
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    connection.invoke("Typing", receiverId);
                    
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(function() {
                        connection.invoke("StopTyping", receiverId);
                    }, 1000);
                }
            });

            // Mark conversation as read on load
            if (receiverId) {
                $.post('@Url.Action("MarkConversationAsRead")/' + receiverId);
            }
        });
    </script>
}
