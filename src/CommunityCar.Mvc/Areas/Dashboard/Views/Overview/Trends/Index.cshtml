@model CommunityCar.Mvc.Areas.Dashboard.ViewModels.Overview.TrendsViewModel
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Trends"];
    ViewData["PageTitle"] = Localizer["Trends Analysis"];
    ViewData["PageSubtitle"] = Localizer["Track growth patterns and trends over time"];
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/dashboard.css" />
}

<div class="dashboard-container">
    <!-- Page Header -->
    <partial name="_OverviewHeader" />

    <!-- Navigation Tabs -->
    <partial name="_OverviewNavTabs" />

    <!-- Charts Grid -->
    <div class="dashboard-content-grid">
        <div class="dashboard-content-main">
            <!-- User Growth Trend -->
            <div class="dashboard-card dashboard-card-primary">
                <div class="dashboard-card-header">
                    <h5 class="dashboard-card-title">@Localizer["User Growth Trend"]</h5>
                    <div class="dashboard-btn-group">
                        <button type="button" class="dashboard-btn-group-item active" data-period="week">@Localizer["Week"]</button>
                        <button type="button" class="dashboard-btn-group-item" data-period="month">@Localizer["Month"]</button>
                        <button type="button" class="dashboard-btn-group-item" data-period="year">@Localizer["Year"]</button>
                    </div>
                </div>
                <div class="dashboard-card-body">
                    <canvas id="growthTrendChart" height="80"></canvas>
                </div>
            </div>

            <!-- Weekly Activity -->
            <div class="dashboard-card dashboard-card-success">
                <div class="dashboard-card-header">
                    <h5 class="dashboard-card-title">@Localizer["Weekly Activity"]</h5>
                </div>
                <div class="dashboard-card-body">
                    <canvas id="activityChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <div class="dashboard-content-sidebar">
            <!-- Content Distribution -->
            <div class="dashboard-card dashboard-card-info">
                <div class="dashboard-card-header">
                    <h5 class="dashboard-card-title">@Localizer["Content Distribution"]</h5>
                </div>
                <div class="dashboard-card-body">
                    <canvas id="contentChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // User Growth Trend Chart
        const growthCtx = document.getElementById('growthTrendChart');
        const growthData = @Html.Raw(Json.Serialize(Model.UserGrowth.Select(u => u.Value)));
        const growthLabels = @Html.Raw(Json.Serialize(Model.UserGrowth.Select(u => u.Label)));

        let growthChart = new Chart(growthCtx, {
            type: 'line',
            data: {
                labels: growthLabels,
                datasets: [{
                    label: '@Localizer["New Users"]',
                    data: growthData,
                    borderColor: 'rgb(251, 44, 54)',
                    backgroundColor: 'rgba(251, 44, 54, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: true } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });

        // Period buttons
        document.querySelectorAll('.dashboard-btn-group-item').forEach(btn => {
            btn.addEventListener('click', async function() {
                const period = this.dataset.period;
                document.querySelectorAll('.dashboard-btn-group-item').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                try {
                    const response = await fetch(`/@ViewContext.RouteData.Values["culture"]/Dashboard/Trends/GetTrendData?period=${period}&type=users`);
                    const result = await response.json();
                    
                    if (result.success) {
                        growthChart.data.labels = result.labels;
                        growthChart.data.datasets[0].data = result.data;
                        growthChart.update();
                    }
                } catch (error) {
                    console.error('Error fetching trend data:', error);
                }
            });
        });

        // Weekly Activity Chart
        const activityCtx = document.getElementById('activityChart');
        const activityData = @Html.Raw(Json.Serialize(Model.WeeklyActivity.Select(a => a.Value)));
        const activityLabels = @Html.Raw(Json.Serialize(Model.WeeklyActivity.Select(a => a.Label)));

        new Chart(activityCtx, {
            type: 'bar',
            data: {
                labels: activityLabels,
                datasets: [{
                    label: '@Localizer["Registrations"]',
                    data: activityData,
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderColor: 'rgb(34, 197, 94)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });

        // Content Distribution Chart
        const contentCtx = document.getElementById('contentChart');
        const contentData = @Html.Raw(Json.Serialize(Model.ContentDistribution.Select(c => c.Value)));
        const contentLabels = @Html.Raw(Json.Serialize(Model.ContentDistribution.Select(c => c.Label)));

        new Chart(contentCtx, {
            type: 'doughnut',
            data: {
                labels: contentLabels,
                datasets: [{
                    data: contentData,
                    backgroundColor: [
                        'rgba(251, 44, 54, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    </script>
}
