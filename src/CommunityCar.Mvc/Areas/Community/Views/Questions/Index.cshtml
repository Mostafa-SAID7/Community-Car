@model CommunityCar.Domain.Base.PagedResult<CommunityCar.Domain.DTOs.Community.QuestionDto>
@{
    ViewData["Title"] = "Questions & Answers";
    var currentTag = ViewBag.CurrentTag as string;
    var isResolved = ViewBag.IsResolved as bool?;
    var searchTerm = ViewBag.SearchTerm as string;
    var sortBy = ViewBag.SortBy as string ?? "created";
    var sortDesc = ViewBag.SortDesc as bool? ?? true;
    var currentTab = ViewBag.CurrentTab as string ?? "all";
}

<link rel="stylesheet" href="~/css/pages/qa.css" />

<div class="qa-container">
    <!-- Header -->
    <div class="qa-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">Questions & Answers</h1>
                <p class="mb-0 opacity-90">Get help from the community or share your knowledge</p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <a asp-action="Create" class="btn btn-light btn-lg">
                    <i class="fas fa-plus me-2"></i>Ask Question
                </a>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="qa-tabs mb-4">
        <ul class="nav nav-tabs qa-nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link @(currentTab == "all" ? "active" : "")" 
                   asp-action="Index" 
                   asp-route-tab="all"
                   asp-route-search="@searchTerm"
                   asp-route-tag="@currentTag"
                   asp-route-sortBy="@sortBy"
                   asp-route-sortDesc="@sortDesc">
                    <i class="fas fa-list me-2"></i>All Questions
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link @(currentTab == "trending" ? "active" : "")" 
                   asp-action="Index" 
                   asp-route-tab="trending"
                   asp-route-search="@searchTerm"
                   asp-route-tag="@currentTag"
                   asp-route-sortBy="@sortBy"
                   asp-route-sortDesc="@sortDesc">
                    <i class="fas fa-fire me-2"></i>Trending
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link @(currentTab == "recent" ? "active" : "")" 
                   asp-action="Index" 
                   asp-route-tab="recent"
                   asp-route-search="@searchTerm"
                   asp-route-tag="@currentTag"
                   asp-route-sortBy="@sortBy"
                   asp-route-sortDesc="@sortDesc">
                    <i class="fas fa-clock me-2"></i>Recent
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link @(currentTab == "unanswered" ? "active" : "")" 
                   asp-action="Index" 
                   asp-route-tab="unanswered"
                   asp-route-search="@searchTerm"
                   asp-route-tag="@currentTag"
                   asp-route-sortBy="@sortBy"
                   asp-route-sortDesc="@sortDesc">
                    <i class="fas fa-question-circle me-2"></i>Unanswered
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link @(currentTab == "answered" ? "active" : "")" 
                   asp-action="Index" 
                   asp-route-tab="answered"
                   asp-route-search="@searchTerm"
                   asp-route-tag="@currentTag"
                   asp-route-sortBy="@sortBy"
                   asp-route-sortDesc="@sortDesc">
                    <i class="fas fa-check-circle me-2"></i>Answered
                </a>
            </li>
            @if (User.Identity?.IsAuthenticated == true)
            {
                <li class="nav-item" role="presentation">
                    <a class="nav-link @(currentTab == "myquestions" ? "active" : "")" 
                       asp-action="Index" 
                       asp-route-tab="myquestions"
                       asp-route-search="@searchTerm"
                       asp-route-tag="@currentTag"
                       asp-route-sortBy="@sortBy"
                       asp-route-sortDesc="@sortDesc">
                        <i class="fas fa-user me-2"></i>My Questions
                    </a>
                </li>
            }
        </ul>
    </div>

    <!-- Search and Sort -->
    <div class="qa-search-section mb-4">
        <form asp-action="Index" method="get" id="searchForm">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" 
                               class="form-control" 
                               name="search" 
                               id="searchInput"
                               value="@searchTerm"
                               placeholder="Search questions by title, content, or tags...">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i> Search
                        </button>
                        @if (!string.IsNullOrEmpty(searchTerm))
                        {
                            <a asp-action="Index" 
                               asp-route-tab="@currentTab"
                               asp-route-tag="@currentTag" 
                               asp-route-isResolved="@isResolved"
                               asp-route-sortBy="@sortBy"
                               asp-route-sortDesc="@sortDesc"
                               class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                        }
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="sortBy" id="sortBySelect" onchange="document.getElementById('searchForm').submit()">
                        <option value="created" selected="@(sortBy == "created")">Newest</option>
                        <option value="votes" selected="@(sortBy == "votes")">Most Votes</option>
                        <option value="answers" selected="@(sortBy == "answers")">Most Answers</option>
                        <option value="views" selected="@(sortBy == "views")">Most Views</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="pageSize" id="pageSizeSelect" onchange="document.getElementById('searchForm').submit()">
                        <option value="10" selected="@(Model.PageSize == 10)">10 per page</option>
                        <option value="20" selected="@(Model.PageSize == 20)">20 per page</option>
                        <option value="50" selected="@(Model.PageSize == 50)">50 per page</option>
                        <option value="100" selected="@(Model.PageSize == 100)">100 per page</option>
                    </select>
                </div>
            </div>
            <input type="hidden" name="tab" value="@currentTab" />
            <input type="hidden" name="tag" value="@currentTag" />
            <input type="hidden" name="isResolved" value="@isResolved" />
            <input type="hidden" name="sortDesc" value="@sortDesc" />
        </form>
    </div>

    <!-- Active Filters -->
    @if (!string.IsNullOrEmpty(currentTag) || !string.IsNullOrEmpty(searchTerm))
    {
        <div class="qa-active-filters mb-3">
            <div class="d-flex gap-2 flex-wrap align-items-center">
                <span class="text-muted">Active filters:</span>
                
                @if (!string.IsNullOrEmpty(currentTag))
                {
                    <span class="badge bg-primary">
                        Tag: @currentTag
                        <a asp-action="Index" 
                           asp-route-tab="@currentTab"
                           asp-route-search="@searchTerm"
                           asp-route-isResolved="@isResolved"
                           asp-route-sortBy="@sortBy"
                           asp-route-sortDesc="@sortDesc"
                           class="text-white ms-1">
                            <i class="fas fa-times"></i>
                        </a>
                    </span>
                }
                
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <span class="badge bg-info">
                        Search: "@searchTerm"
                        <a asp-action="Index" 
                           asp-route-tab="@currentTab"
                           asp-route-tag="@currentTag"
                           asp-route-isResolved="@isResolved"
                           asp-route-sortBy="@sortBy"
                           asp-route-sortDesc="@sortDesc"
                           class="text-white ms-1">
                            <i class="fas fa-times"></i>
                        </a>
                    </span>
                }
                
                <a asp-action="Index" asp-route-tab="@currentTab" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>Clear All
                </a>
            </div>
        </div>
    }

    <!-- Results Summary -->
    <div class="qa-results-summary mb-3">
        <div class="text-muted">
            Showing @((Model.PageNumber - 1) * Model.PageSize + 1) - @(Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount)) of @Model.TotalCount questions
        </div>
    </div>

    <!-- Questions List -->
    @if (!Model.Items.Any())
    {
        <div class="text-center py-5">
            <i class="fas fa-question-circle fa-4x text-muted mb-3"></i>
            <h4>No questions found</h4>
            @if (!string.IsNullOrEmpty(searchTerm))
            {
                <p class="text-muted">No results for "@searchTerm". Try a different search term.</p>
                <a asp-action="Index" asp-route-tab="@currentTab" class="btn btn-secondary mt-3">
                    <i class="fas fa-arrow-left me-2"></i>Clear Search
                </a>
            }
            else if (currentTab == "myquestions")
            {
                <p class="text-muted">You haven't asked any questions yet.</p>
                <a asp-action="Create" class="btn btn-primary mt-3">
                    <i class="fas fa-plus me-2"></i>Ask Your First Question
                </a>
            }
            else
            {
                <p class="text-muted">Be the first to ask a question!</p>
                <a asp-action="Create" class="btn btn-primary mt-3">
                    <i class="fas fa-plus me-2"></i>Ask Question
                </a>
            }
        </div>
    }
    else
    {
        @foreach (var question in Model.Items)
        {
            <div class="question-card @(question.IsResolved ? "resolved" : "")">
                <div class="d-flex">
                    <!-- Stats -->
                    <div class="question-stats">
                        <div class="stat-item">
                            <div class="stat-number">@question.VoteCount</div>
                            <div class="stat-label">Votes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">@question.AnswerCount</div>
                            <div class="stat-label">Answers</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">@question.ViewCount</div>
                            <div class="stat-label">Views</div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="question-content">
                        <a asp-action="Details" asp-route-id="@question.Id" class="question-title">
                            @question.Title
                        </a>
                        
                        <div class="question-excerpt">
                            @(question.Content.Length > 200 ? question.Content.Substring(0, 200) + "..." : question.Content)
                        </div>

                        <div class="question-meta">
                            @if (!string.IsNullOrEmpty(question.Tags))
                            {
                                <div class="question-tags">
                                    @foreach (var tag in question.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                    {
                                        <a asp-action="Index" 
                                           asp-route-tab="@currentTab"
                                           asp-route-tag="@tag.Trim()" 
                                           asp-route-search="@searchTerm"
                                           asp-route-isResolved="@isResolved"
                                           asp-route-sortBy="@sortBy"
                                           asp-route-sortDesc="@sortDesc"
                                           class="tag">
                                            @tag.Trim()
                                        </a>
                                    }
                                </div>
                            }

                            <div class="question-author">
                                <div class="author-avatar">
                                    @question.AuthorName.Substring(0, Math.Min(2, question.AuthorName.Length)).ToUpper()
                                </div>
                                <span>@question.AuthorName</span>
                                <span class="text-muted">â€¢</span>
                                <span class="text-muted">@question.CreatedAt.ToString("MMM dd, yyyy")</span>
                            </div>

                            @if (question.IsResolved)
                            {
                                <span class="resolved-badge">
                                    <i class="fas fa-check-circle"></i> Resolved
                                </span>
                            }

                            <div class="ms-auto d-flex gap-2">
                                <span class="text-muted small">
                                    <i class="fas fa-bookmark"></i> @question.BookmarkCount
                                </span>
                                <span class="text-muted small">
                                    <i class="fas fa-heart"></i> @question.ReactionCount
                                </span>
                                <span class="text-muted small">
                                    <i class="fas fa-share"></i> @question.ShareCount
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Questions pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    <!-- Previous Button -->
                    <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                        <a class="page-link" 
                           asp-action="Index" 
                           asp-route-page="@(Model.PageNumber - 1)" 
                           asp-route-tab="@currentTab"
                           asp-route-search="@searchTerm"
                           asp-route-tag="@currentTag" 
                           asp-route-isResolved="@isResolved"
                           asp-route-sortBy="@sortBy"
                           asp-route-sortDesc="@sortDesc"
                           asp-route-pageSize="@Model.PageSize">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>

                    @{
                        var startPage = Math.Max(1, Model.PageNumber - 2);
                        var endPage = Math.Min(Model.TotalPages, Model.PageNumber + 2);
                        
                        if (startPage > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" 
                                   asp-action="Index" 
                                   asp-route-page="1" 
                                   asp-route-tab="@currentTab"
                                   asp-route-search="@searchTerm"
                                   asp-route-tag="@currentTag" 
                                   asp-route-isResolved="@isResolved"
                                   asp-route-sortBy="@sortBy"
                                   asp-route-sortDesc="@sortDesc"
                                   asp-route-pageSize="@Model.PageSize">
                                    1
                                </a>
                            </li>
                            if (startPage > 2)
                            {
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            }
                        }

                        for (int i = startPage; i <= endPage; i++)
                        {
                            <li class="page-item @(Model.PageNumber == i ? "active" : "")">
                                <a class="page-link" 
                                   asp-action="Index" 
                                   asp-route-page="@i" 
                                   asp-route-tab="@currentTab"
                                   asp-route-search="@searchTerm"
                                   asp-route-tag="@currentTag" 
                                   asp-route-isResolved="@isResolved"
                                   asp-route-sortBy="@sortBy"
                                   asp-route-sortDesc="@sortDesc"
                                   asp-route-pageSize="@Model.PageSize">
                                    @i
                                </a>
                            </li>
                        }

                        if (endPage < Model.TotalPages)
                        {
                            if (endPage < Model.TotalPages - 1)
                            {
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            }
                            <li class="page-item">
                                <a class="page-link" 
                                   asp-action="Index" 
                                   asp-route-page="@Model.TotalPages" 
                                   asp-route-tab="@currentTab"
                                   asp-route-search="@searchTerm"
                                   asp-route-tag="@currentTag" 
                                   asp-route-isResolved="@isResolved"
                                   asp-route-sortBy="@sortBy"
                                   asp-route-sortDesc="@sortDesc"
                                   asp-route-pageSize="@Model.PageSize">
                                    @Model.TotalPages
                                </a>
                            </li>
                        }
                    }

                    <!-- Next Button -->
                    <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                        <a class="page-link" 
                           asp-action="Index" 
                           asp-route-page="@(Model.PageNumber + 1)" 
                           asp-route-tab="@currentTab"
                           asp-route-search="@searchTerm"
                           asp-route-tag="@currentTag" 
                           asp-route-isResolved="@isResolved"
                           asp-route-sortBy="@sortBy"
                           asp-route-sortDesc="@sortDesc"
                           asp-route-pageSize="@Model.PageSize">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        }
    }
</div>

@section Scripts {
    <script>
        // Enable Enter key for search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchForm').submit();
            }
        });

        // Preserve search term when changing filters
        document.querySelectorAll('.qa-filter-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                const searchTerm = document.getElementById('searchInput').value;
                if (searchTerm) {
                    const url = new URL(this.href);
                    url.searchParams.set('search', searchTerm);
                    this.href = url.toString();
                }
            });
        });
    </script>
}
